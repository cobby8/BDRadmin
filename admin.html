<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BDR ê´€ë¦¬ì</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --blue:#1769ff; --bg:#f6f8fb; --card:#fff; --muted:#6b7684; --red:#ef4444; --green:#16a34a }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:'Pretendard','Apple SD Gothic Neo',sans-serif;color:#222}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px 64px}
  header{display:flex;justify-content:space-between;align-items:center;margin:10px 0 18px}
  h1{font-size:20px;margin:0}
  .card{background:var(--card);border-radius:14px;box-shadow:0 8px 28px rgba(23,105,255,.08);padding:16px;margin-top:16px}
  .row{display:grid;gap:12px}
  @media(min-width:720px){ .row-2{grid-template-columns:1.2fr 2fr} .row-3{grid-template-columns:1fr 1fr 1fr} }
  label{display:block;font-weight:600;margin:10px 0 6px}
  input,select,textarea{width:100%;padding:12px;border:1px solid #e6ecf5;border-radius:12px;font-size:14px;outline:none;background:#fff}
  input:focus,select:focus,textarea:focus{border-color:var(--blue)}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid #dfe6ee;background:#fff;cursor:pointer}
  .btn.primary{background:var(--blue);color:#fff;border-color:var(--blue)}
  .btn.danger{background:#fff;color:var(--red);border-color:#ffd1d1}
  .btn.ghost{background:#fff;color:#334155;border-color:#e6ecf5}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted);font-size:12px}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  th{font-size:12px;color:#5b6472;text-align:left;padding:0 10px}
  td{background:#fff;padding:12px 10px;border-top:1px solid #eef2f7;border-bottom:1px solid #eef2f7}
  tr td:first-child{border-left:1px solid #eef2f7;border-radius:12px 0 0 12px}
  tr td:last-child{border-right:1px solid #eef2f7;border-radius:0 12px 12px 0}
  .badge{display:inline-flex;gap:6px;align-items:center;font-size:12px;color:#334155;background:#f1f5fb;border:1px solid #e4ecf7;border-radius:999px;padding:4px 8px}
  .right{display:flex;justify-content:flex-end}
  .w-140{width:140px}
  .jersey{display:inline-flex;align-items:center;gap:6px}
  .searchbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-block;border:1px solid #e6ecf5;border-radius:999px;padding:6px 10px;font-size:12px;margin:2px 0;background:#fff}
  .grid{display:grid;gap:10px}
  .grid-2{grid-template-columns:1fr 1fr}
  .grid-3{grid-template-columns:1fr 1fr 1fr}
  .help{font-size:12px;color:#6b7280}
  .section-title{font-weight:700;margin:16px 0 6px}
  .subtle{font-size:13px;color:#475569;margin-top:-6px}
  .place-item{display:grid;gap:8px;grid-template-columns:1fr 3fr auto;align-items:center;border:1px solid #e6ecf5;border-radius:12px;padding:10px;background:#fff}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px solid #e6ecf5;border-radius:999px;padding:6px 10px;font-size:12px;background:#fff;cursor:pointer}
  .list{display:grid;gap:10px}
  .hr{height:1px;background:#eef2f7;margin:8px 0}
  /* ì¢…ë³„ ì„ íƒ ëª¨ë‹¬ */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
  .modal .panel{background:#fff;width:min(720px,96vw);max-height:90vh;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.18);display:flex;flex-direction:column}
  .modal .panel header{padding:12px 16px;border-bottom:1px solid #eef2f7}
  .modal .panel main{padding:12px 16px;overflow:auto}
  .rowChk{display:flex;gap:8px;flex-wrap:wrap}
  .rowChk>label{display:flex;gap:6px;align-items:center;border:1px solid #e6ecf5;border-radius:999px;padding:6px 10px}
  /* ê´€ë¦¬ì½”ë“œ ëˆˆì•„ì´ì½˜ */
  .input-icon{position:relative}
  .eye-btn{position:absolute;right:10px;top:50%;transform:translateY(-50%);border:0;background:transparent;cursor:pointer;font-size:16px}
  /* ë³´ê¸°ëª¨ë“œ ë¹„í™œì„± */
  .view input:not([data-allow-view]), .view textarea, .view select{background:#f8fafc; pointer-events:none; opacity:.85}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>BDR ê´€ë¦¬ì</h1>
    <div class="toolbar">
      <span class="muted" id="healthDot">â—</span>
      <button class="btn" id="settingsBtn">âš™ï¸ ì„¤ì •</button>
      <button class="btn" id="reloadBtn">ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </header>

  <!-- ëŒ€íšŒ í•„í„° -->
  <div class="card">
    <div class="row row-3">
      <div>
        <label>ëŒ€íšŒ í•„í„°</label>
        <select id="tourFilter"><option value="">ì „ì²´ ëŒ€íšŒ</option></select>
      </div>
      <div class="muted" style="align-self:end">â€» Apps Script URLì€ âš™ï¸ì—ì„œ ë³€ê²½, ì£¼ì†Œê²€ìƒ‰ì€ í–‰ì•ˆë¶€ íŒì—… ì‚¬ìš©.</div>
    </div>
  </div>

  <!-- ëŒ€íšŒ ê´€ë¦¬ (ë³´ê¸°ëª¨ë“œ ê¸°ë³¸ / ìˆ˜ì •ì€ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í›„) -->
  <div class="card" id="formCard">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0;font-size:16px">ëŒ€íšŒ ê´€ë¦¬</h3>
      <div class="toolbar">
        <button class="btn" id="newTourBtn">ì‹ ê·œ ëŒ€íšŒ</button>
        <button class="btn" id="editBtn" disabled>ìˆ˜ì •</button>
        <button class="btn primary" id="saveTourBtn" style="display:none">ì €ì¥</button>
        <button class="btn danger" id="deleteTourBtn" style="display:none">ì‚­ì œ</button>
      </div>
    </div>

    <div class="row row-2">
      <!-- ì¢Œ: ëŒ€íšŒ ëª©ë¡ -->
      <div>
        <label>ëŒ€íšŒ ëª©ë¡</label>
        <div id="tourList" class="grid"></div>
      </div>

      <!-- ìš°: ëŒ€íšŒ ë³´ê¸°/ìˆ˜ì • í¼ -->
      <div id="formBox">
        <label id="tourFormTitle">ëŒ€íšŒ ë³´ê¸°</label>

        <!-- ê¸°ë³¸ì •ë³´ -->
        <div class="grid">
          <input id="tourId" placeholder="ìë™ìƒì„± (ìˆ˜ì • ì‹œ ê³ ì •)" disabled data-allow-view>
          <input id="tourName" placeholder="ëŒ€íšŒëª…" autocomplete="off" name="x_tour_name">
          <!-- URL ìë™ì™„ì„± ë°©ì§€: readonly â†’ focus ì‹œ í•´ì œ -->
          <input id="tourUrl" placeholder="ì•ˆë‚´ í˜ì´ì§€ URL (ì„ íƒ)" autocomplete="off" name="x_tour_url" readonly>
        </div>

        <!-- ì¢…ë³„: ë³´ê¸°ëª¨ë“œì—” ì¹©ë§Œ ë³´ì„ / ì¶”ê°€ ë²„íŠ¼ìœ¼ë¡œ ì„ íƒ ì°½ -->
        <div class="section-title">ì¢…ë³„ ì„¤ì •</div>
        <div class="subtle">ì„ íƒëœ ì¢…ë³„ë§Œ í‘œì‹œë©ë‹ˆë‹¤. <b>+ êµ¬ë¶„/ì¢…ë³„ ì¶”ê°€</b> ë²„íŠ¼ìœ¼ë¡œ ì„ íƒ ì°½ì„ ì—´ì–´ ì²´í¬ í›„ ì ìš©í•˜ì„¸ìš”. ì¹©ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ì¢…ë³„ì´ ì œê±°ë©ë‹ˆë‹¤.</div>
        <div id="divSetList" class="list" style="margin-top:8px"></div>
        <div class="toolbar" style="margin-top:6px;justify-content:flex-end">
          <button class="btn ghost" id="addDivSetBtn">+ êµ¬ë¶„/ì¢…ë³„ ì¶”ê°€</button>
        </div>

        <div class="hr"></div>

        <!-- ëŒ€íšŒì¥ì†Œ -->
        <div class="section-title">ëŒ€íšŒì¥ì†Œ</div>
        <div class="subtle">í–‰ì •ì•ˆì „ë¶€ ì£¼ì†Œê²€ìƒ‰ íŒì—…ìœ¼ë¡œ ì£¼ì†Œë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
        <div id="placeList" class="list" style="margin-top:8px"></div>
        <div class="toolbar" style="margin-top:6px;justify-content:flex-end">
          <button class="btn ghost" id="addPlaceBtn">+ ì¥ì†Œ ì¶”ê°€</button>
        </div>

        <div class="hr"></div>

        <!-- ëŒ€íšŒê¸°ê°„ -->
        <div class="section-title">ëŒ€íšŒê¸°ê°„</div>
        <div class="grid grid-2">
          <input id="tourStart" type="date" placeholder="ì‹œì‘ì¼" autocomplete="off" name="x_start_date">
          <input id="tourEnd" type="date" placeholder="ì¢…ë£Œì¼" autocomplete="off" name="x_end_date">
        </div>
        <div class="help" style="margin-top:4px">ëŒ€íšŒê°€ ì—´ë¦¬ëŠ” ë‚ ì§œ êµ¬ê°„ì…ë‹ˆë‹¤.</div>

        <!-- ì ‘ìˆ˜ê¸°ê°„ -->
        <div class="section-title" style="margin-top:14px">ì ‘ìˆ˜ê¸°ê°„</div>
        <div class="grid grid-2">
          <input id="regStart" type="datetime-local" placeholder="ì ‘ìˆ˜ ì‹œì‘" autocomplete="off" name="x_reg_start">
          <input id="regEnd" type="datetime-local" placeholder="ì ‘ìˆ˜ ì¢…ë£Œ" autocomplete="off" name="x_reg_end">
        </div>
        <div class="help" style="margin-top:4px">ì°¸ê°€ì‹ ì²­ ì ‘ìˆ˜ ê°€ëŠ¥ ì‹œê°„ì…ë‹ˆë‹¤. (ë‚ ì§œ+ì‹œê°„)</div>

        <!-- ê´€ë¦¬ì½”ë“œ + ìƒíƒœ(ìë™) -->
        <div style="margin-top:12px">
          <label>ëŒ€íšŒê´€ë¦¬ ì½”ë“œ (í•„ìˆ˜)</label>
          <div class="input-icon">
            <input id="adminCode" type="password" placeholder="ì´ ëŒ€íšŒë¥¼ ê´€ë¦¬í•  ë¹„ë°€ë²ˆí˜¸" autocomplete="new-password" name="x_admin_code" readonly>
            <button class="eye-btn" id="toggleCodeBtn" title="ë³´ê¸°/ìˆ¨ê¸°ê¸°">ğŸ‘ï¸</button>
          </div>
          <div class="help">ì‹ ê·œ ìƒì„± ì‹œ ì„¤ì •, ì´í›„ ìˆ˜ì •/ì‚­ì œ ì‹œ ë™ì¼ ì½”ë“œ í•„ìš”. (ë³´ê¸°ëª¨ë“œì—ì„  ë¹„í™œì„±)</div>

          <div style="margin-top:8px">
            <label>ìƒíƒœ(ìë™)</label>
            <div id="tourStatusBadge" class="badge">ìƒíƒœë¯¸ì •</div>
            <div class="help">ì ‘ìˆ˜ê¸°ê°„ì— ë”°ë¼ ìë™ í‘œì‹œ(ì ‘ìˆ˜ì „/ì ‘ìˆ˜ì¤‘/ë§ˆê°). ìˆ˜ë™ ë³€ê²½ ë¶ˆê°€.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- íŒ€/ì„ ìˆ˜ -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0;font-size:16px">íŒ€ / ì„ ìˆ˜</h3>
      <div class="searchbar">
        <input id="searchText" placeholder="íŒ€ëª…/ëŒ€í‘œì/ì—°ë½ì²˜ ê²€ìƒ‰" class="w-140">
        <button class="btn" id="searchBtn">ê²€ìƒ‰</button>
      </div>
    </div>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>íŒ€ID</th><th>ëŒ€íšŒ</th><th>ì§€ì—­</th><th>íŒ€ëª… / ëŒ€í‘œ</th>
            <th>ì¢…ë³„Â·ë””ë¹„ì „</th><th>ìœ ë‹ˆí¼</th><th>ì‹ ì²­ì¼ì‹œ</th><th></th>
          </tr>
        </thead>
        <tbody id="teamsTbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- êµ¬ë¶„/ì¢…ë³„ ì„ íƒ ëª¨ë‹¬ -->
<div class="modal" id="divModal">
  <div class="panel">
    <header style="display:flex;align-items:center;justify-content:space-between">
      <div style="font-weight:700">êµ¬ë¶„/ì¢…ë³„ ì„ íƒ</div>
      <div class="toolbar"><button class="btn" id="divCloseBtn">ë‹«ê¸°</button></div>
    </header>
    <main>
      <div class="grid grid-2" style="margin-bottom:8px">
        <div>
          <label>êµ¬ë¶„</label>
          <select id="divGroupSel">
            <option>ì¼ë°˜ë¶€</option><option>ëŒ€í•™ë¶€</option><option>ì—¬ì„±ë¶€</option><option>ìœ ì†Œë…„ë¶€</option>
          </select>
        </div>
        <div>
          <label>ì¢…ë³„</label>
          <div id="divChkBox" class="rowChk"></div>
        </div>
      </div>
      <div class="right" style="margin-top:8px">
        <button class="btn" id="divApplyBtn">ì ìš©</button>
      </div>
    </main>
  </div>
</div>

<script>
/* ================== ìƒìˆ˜/ì„¤ì • ================== */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz1qk5MbQvVU3d8Qs3EcPO792iBNlVQR71WhCpNbkqzCcdn5gM17Hqx9AUAIGUwwSKCww/exec';
const APPLY_BASE  = 'https://bdrjoin.netlify.app/';
const JUSO_KEY    = 'U01TX0FVVEgyMDI1MDkwOTIzNTcyMjExNjE2NDQ='; // í–‰ì•ˆë¶€ íŒì—… ìŠ¹ì¸í‚¤

const store = { key: 'BDR_ADMIN_CONF',
  load(){ try { return JSON.parse(localStorage.getItem(this.key) || '{}'); } catch { return {} } },
  save(obj){ localStorage.setItem(this.key, JSON.stringify(obj||{})); }
};
const conf = store.load();
if (!conf.appUrl && WEB_APP_URL) { conf.appUrl = WEB_APP_URL; store.save(conf); }

const $=s=>document.querySelector(s);
const el=html=>{ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstElementChild; };

/* ================== ë³´ê¸°/ìˆ˜ì • ëª¨ë“œ & ë”í‹° ê°€ë“œ ================== */
let FORM_MODE = 'view';     // 'view' | 'edit' | 'new'
let DIRTY = false;
function setDirty(){ if (FORM_MODE!=='view') DIRTY = true; }
function resetDirty(){ DIRTY = false; }
window.addEventListener('beforeunload', (e)=>{ if (DIRTY){ e.preventDefault(); e.returnValue=''; } });
function guardUnsaved(){
  if (!DIRTY) return true;
  const ok = confirm('ì €ì¥í•˜ì§€ ì•Šì€ ë³€ê²½ ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
  if (ok) resetDirty();
  return ok;
}
function setMode(mode){
  FORM_MODE = mode;
  const formCard = $('#formCard');
  formCard.classList.toggle('view', mode==='view');

  // ë²„íŠ¼ í‘œì‹œ/ë¹„í™œì„±
  $('#saveTourBtn').style.display  = (mode==='edit' || mode==='new') ? '' : 'none';
  $('#deleteTourBtn').style.display= (mode==='edit') ? '' : 'none';
  $('#editBtn').disabled = !(mode==='view' && ($('#tourId').value||'').trim());

  // ì¸í’‹ í™œì„±/ë¹„í™œì„± (ë³´ê¸°ëª¨ë“œ: ì½ê¸°)
  const inputs = $('#formBox').querySelectorAll('input,select,textarea,button');
  inputs.forEach(elm=>{
    if (elm.id==='toggleCodeBtn' || elm.id==='addDivSetBtn' || elm.dataset.always==='1') return;
    if (mode==='view'){
      if (elm.id!=='tourId') elm.disabled = true;
    }else{
      elm.disabled = false;
    }
  });

  // URL/ê´€ë¦¬ì½”ë“œ ìë™ì™„ì„± ë°©ì§€: focus ë•Œë§Œ ì…ë ¥ í—ˆìš©
  const urlI = $('#tourUrl'), codeI = $('#adminCode');
  if (mode!=='view'){ urlI.readOnly = true; codeI.readOnly = true; }
  urlI.addEventListener('focus', ()=> urlI.readOnly=false, {once:true});
  codeI.addEventListener('focus', ()=> codeI.readOnly=false, {once:true});

  if (mode==='view') resetDirty();
}

/* ================== ê³µí†µ ìœ í‹¸ ================== */
function apiUrl(path, q={}){
  const base = (conf.appUrl||'').trim();
  if (!base) throw new Error('Web App URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìš°ìƒë‹¨ âš™ï¸ì—ì„œ ì„¤ì •í•˜ì„¸ìš”.');
  let u = new URL(base);
  u.searchParams.set('path', path);
  Object.entries(q).forEach(([k,v])=> u.searchParams.set(k, v));
  return u.toString();
}
async function getJSON(u){ const r=await fetch(u); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
async function postJSON(path, payload){
  const r=await fetch(apiUrl(path), { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(payload||{}) });
  if(!r.ok) throw new Error('HTTP '+r.status); return r.json();
}
async function health(){
  try{ const j=await getJSON(apiUrl('health')); $('#healthDot').style.color = j.ok ? '#22c55e' : '#ef4444'; }
  catch{ $('#healthDot').style.color = '#ef4444'; }
}
function pad(n){ return String(n).padStart(2,'0'); }
function fmtDate(v){ if(!v) return ''; const d=new Date(v); if(isNaN(d)) return String(v);
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
/* ë‚ ì§œ/ì‹œê°„ ì…ë ¥ê°’ ë³´ì¡´ (ë¬¸ìì—´ ìš°ì„ ) */
function toInputDateOnly(src){
  if(!src) return '';
  if(typeof src==='string'){ const m=src.match(/^(\d{4}-\d{2}-\d{2})/); if(m) return m[1]; return src; }
  const d=new Date(src); if(!isNaN(d)) return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  return '';
}
function toInputDT(src){
  if(!src) return '';
  if(typeof src==='string'){
    const m=src.match(/^(\d{4}-\d{2}-\d{2})[ T](\d{2}):(\d{2})/);
    if (m) return `${m[1]}T${m[2]}:${m[3]}`;
    return src;
  }
  const d=new Date(src); if(!isNaN(d)) return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  return '';
}
function calcStatus(regStart, regEnd){
  if (!regStart || !regEnd) return 'ìƒíƒœë¯¸ì •';
  const s=new Date(regStart), e=new Date(regEnd), now=new Date();
  if(isNaN(s)||isNaN(e)) return 'ìƒíƒœë¯¸ì •';
  if(now<s) return 'ì ‘ìˆ˜ì „'; if(now>e) return 'ë§ˆê°'; return 'ì ‘ìˆ˜ì¤‘';
}
function statusBadgeHtml(status){
  const c={ 'ì ‘ìˆ˜ì¤‘':{bg:'#ecfdf5',bd:'#d1fae5',fg:'#16a34a'}, 'ì ‘ìˆ˜ì „':{bg:'#eff6ff',bd:'#dbeafe',fg:'#1769ff'}, 'ë§ˆê°':{bg:'#fef2f2',bd:'#fee2e2',fg:'#ef4444'}, 'ìƒíƒœë¯¸ì •':{bg:'#f1f5fb',bd:'#e4ecf7',fg:'#334155'} }[status] || {bg:'#f1f5fb',bd:'#e4ecf7',fg:'#334155'};
  return `<span class="badge" style="background:${c.bg};border-color:${c.bd};color:${c.fg}">${status}</span>`;
}

/* ================== ëŒ€íšŒ ëª©ë¡/í•„í„° ================== */
let TOURS={}, TOUR_ARRAY=[];
async function loadTournaments(){
  const j=await getJSON(apiUrl('tournaments'));
  TOURS={}; TOUR_ARRAY=j.rows||[];
  TOUR_ARRAY.forEach(t=> TOURS[t.TourID]=t);
  renderTournamentList(); renderTourFilter();
}
function renderTournamentList(){
  const box=$('#tourList');
  box.innerHTML=(TOUR_ARRAY||[]).map(t=>{
    const range=(t.start||t.end)?`${fmtDate(t.start)} ~ ${fmtDate(t.end)}`:'ì¼ì •ë¯¸ì •';
    const stat=calcStatus(t.regStart, t.regEnd);
    return `<div class="pill" data-id="${t.TourID}" title="ì„ íƒ"><b>${t.name}</b> Â· ${stat} Â· ${range}</div>`;
  }).join('');
  box.querySelectorAll('.pill').forEach(el=>{
    el.addEventListener('click', ()=>{
      if (!guardUnsaved()) return;
      const t=TOURS[el.dataset.id];
      loadTourToForm(t);
      setMode('view'); // ëª©ë¡ í´ë¦­ ì‹œ ë³´ê¸°ëª¨ë“œ
      $('#editBtn').disabled=false;
    });
  });
}
function renderTourFilter(){
  const sel=$('#tourFilter'); const cur=sel.value;
  sel.innerHTML='<option value="">ì „ì²´ ëŒ€íšŒ</option>';
  TOUR_ARRAY.forEach(t=>{ const o=document.createElement('option'); o.value=t.TourID; o.textContent=t.name; sel.appendChild(o); });
  if(TOUR_ARRAY.find(x=>x.TourID===cur)) sel.value=cur;
}

/* ================== íŒ€ í‘œ ================== */
function jerseySVG(hex,label){ const color=(/^#[0-9a-f]{6}$/i).test(hex||'')?hex:'#e5e7eb', text=(label||'').toUpperCase();
  return `<svg width="42" height="52" viewBox="0 0 42 52" xmlns="http://www.w3.org/2000/svg"><g filter="url(#s)">
  <path d="M14 3 l4 6 h6 l4-6 h6 v15 l3 3 v27 a3 3 0 0 1 -3 3 h-26 a3 3 0 0 1 -3 -3 v-27 l3-3 v-15 z" fill="${color}" stroke="#cbd5e1"/>
  <text x="21" y="31" font-family="system-ui,sans-serif" font-size="9" fill="#0f172a" text-anchor="middle" font-weight="700">${text}</text>
</g><defs><filter id="s" x="0" y="0" width="42" height="52"><feDropShadow dx="0" dy="1" stdDeviation="1" flood-color="#000" flood-opacity=".08"/></filter></defs></svg>`;}
function normalizeTeamRow(r){
  const region=[r.ì‹œë„||r.province||'', r.ì‹œêµ°êµ¬||r.city||''].join(' ').trim();
  const cat=r.ì¢…ë³„||r.category||'', div=r.ë””ë¹„ì „||r.division||'';
  function pickHex(p,f){ if(typeof p==='string' && /^#[0-9a-f]{6}$/i.test(p)) return p.toLowerCase(); if(typeof f==='string'){ const m=f.match(/#([0-9a-f]{6})/i); if(m) return('#'+m[1]).toLowerCase(); } return ''; }
  const homeHex=pickHex(r.uniformHomeHex, r['ìœ ë‹ˆí¼(í™ˆ)']), awayHex=pickHex(r.uniformAwayHex, r['ìœ ë‹ˆí¼(ì–´ì›¨ì´)']);
  return {teamId:r.TeamID||r.teamId||'', tourId:(r.TourID||r.tourId||'').toString().trim(), tourName:r.tourName||r.TourName||r['ëŒ€íšŒëª…']||'', region, teamName:r.íŒ€ëª…||r.teamName||'', managerName:r.ëŒ€í‘œìì´ë¦„||r.managerName||'', managerPhone:r.ëŒ€í‘œìì—°ë½ì²˜||r.managerPhone||'', category:cat, division:div, homeHex, awayHex, createdAt:r.ì‹ ì²­ì¼ì‹œ||r.createdAt||'', editCode:r.ìˆ˜ì •ì½”ë“œ||r.editCode||'' };
}
function rowTeam(v){
  return `<tr><td>${v.teamId}</td><td>${v.tourName||'-'}</td><td>${v.region||'-'}</td>
  <td><div><b>${v.teamName||''}</b></div><div class="muted">${v.managerName||''} Â· ${v.managerPhone||''}</div></td>
  <td>${v.category||''} Â· ${v.division||''}</td>
  <td><div class="jersey">${jerseySVG(v.homeHex,'HOME')}${jerseySVG(v.awayHex,'AWAY')}</div></td>
  <td>${fmtDate(v.createdAt)}</td>
  <td class="right"><a class="btn" href="${editUrlFor(v.teamId, v.editCode)}" target="_blank" rel="noopener">ìˆ˜ì • ì—´ê¸°</a></td></tr>`;
}
function editUrlFor(teamId, editCode){ const base=APPLY_BASE.replace(/index\.html$/,''); const sep=base.endsWith('/')?'':'/'; return `${base}${sep}?edit=${encodeURIComponent(teamId)}&code=${encodeURIComponent(editCode||'')}`; }
async function loadTeams(){
  try{
    const tourId=($('#tourFilter').value||'').trim();
    const j=await getJSON(apiUrl('teams', tourId?{tourId}:{}) );
    let rows=Array.isArray(j.rows)?j.rows:[]; if(tourId) rows=rows.filter(r=>String(r.TourID||r.tourId||'').trim()===tourId);
    const q=($('#searchText').value||'').trim().toLowerCase();
    if(q){ rows=rows.filter(r=>{ const v=normalizeTeamRow(r); return [v.teamId,v.tourName,v.region,v.teamName,v.managerName,v.managerPhone,v.category,v.division].join(' ').toLowerCase().includes(q); }); }
    $('#teamsTbody').innerHTML = rows.map(r=>rowTeam(normalizeTeamRow(r))).join('') || `<tr><td colspan="8" class="muted">ë°ì´í„° ì—†ìŒ</td></tr>`;
  }catch(e){ $('#teamsTbody').innerHTML = `<tr><td colspan="8" class="muted">ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: ${e.message}</td></tr>`; }
}

/* ================== ì¢…ë³„(ì¹©ë§Œ í‘œì‹œ + ì„ íƒ ëª¨ë‹¬) ================== */
const DIVISION_PRESETS = { 'ì¼ë°˜ë¶€':['D3','D4','D5','D6','D7'], 'ëŒ€í•™ë¶€':['U1','U2','U3','UW'], 'ì—¬ì„±ë¶€':['D3','D4','D5'], 'ìœ ì†Œë…„ë¶€':['í•˜ëª¨ë‹ˆ','i1','i2','i3','i4'] };

function makeDivSetRow(init={ group:'ì¼ë°˜ë¶€', divisions:[] }){
  const row = el(`<div class="place-item"></div>`);
  const groupLabel = el(`<div><b>${init.group||'êµ¬ë¶„'}</b></div>`);
  const chipsWrap  = el(`<div class="chips"></div>`);
  const ctrl       = el(`<div style="display:flex;gap:6px;align-items:center">
    <button class="btn danger" data-del>ì‚­ì œ</button>
  </div>`);
  ctrl.querySelector('[data-del]').addEventListener('click', ()=>{ setDirty(); row.remove(); });

  function refresh(){
    chipsWrap.innerHTML = (init.divisions||[]).length
      ? init.divisions.map(v=>`<span class="chip" data-v="${v}" title="í´ë¦­í•˜ì—¬ ì œê±°">${v} Ã—</span>`).join('')
      : '<span class="muted">ë¯¸ì„ íƒ</span>';
    chipsWrap.querySelectorAll('.chip').forEach(c=>{
      c.addEventListener('click', ()=>{ setDirty(); const v=c.getAttribute('data-v'); init.divisions=init.divisions.filter(x=>x!==v); refresh(); });
    });
  }
  refresh();

  row.appendChild(groupLabel); row.appendChild(chipsWrap); row.appendChild(ctrl);
  row.getValue = ()=>({ group: init.group, divisions: (init.divisions||[]).slice() });
  row.addDivisions = (group, divs)=>{
    if (group !== init.group) init.group = group;
    init.divisions = Array.from(new Set([...(init.divisions||[]), ...divs]));
    groupLabel.innerHTML = `<b>${init.group}</b>`; setDirty(); refresh();
  };
  return row;
}
function getDivSets(){ return [...document.querySelectorAll('#divSetList .place-item')].map(it=> it.getValue()); }
function setDivSets(list){
  const box=$('#divSetList'); box.innerHTML='';
  (list&&list.length?list:[{group:'ì¼ë°˜ë¶€',divisions:[]}]).forEach(v=> box.appendChild(makeDivSetRow({group:v.group, divisions:[...(v.divisions||[])]})));
}

/* ì„ íƒ ëª¨ë‹¬ */
const divModal = $('#divModal'), divGroupSel = $('#divGroupSel'), divChkBox = $('#divChkBox');
function openDivModal(onApply){
  divModal.style.display='flex';
  divGroupSel.value = 'ì¼ë°˜ë¶€';
  renderDivChecks('ì¼ë°˜ë¶€');
  divModal._onApply = onApply;
}
function closeDivModal(){ divModal.style.display='none'; divModal._onApply=null; }
function renderDivChecks(group){
  const opts = DIVISION_PRESETS[group]||[];
  divChkBox.innerHTML = opts.map(v=>`<label><input type="checkbox" value="${v}"><span>${v}</span></label>`).join('');
}
divGroupSel.addEventListener('change', ()=> renderDivChecks(divGroupSel.value));
$('#divApplyBtn').addEventListener('click', ()=>{
  const vals = [...divChkBox.querySelectorAll('input[type="checkbox"]:checked')].map(i=>i.value);
  if (!vals.length){ alert('ì¢…ë³„ì„ 1ê°œ ì´ìƒ ì„ íƒí•˜ì„¸ìš”.'); return; }
  if (typeof divModal._onApply === 'function') divModal._onApply(divGroupSel.value, vals);
  closeDivModal();
});
$('#divCloseBtn').addEventListener('click', closeDivModal);
divModal.addEventListener('click', (e)=>{ if(e.target.id==='divModal') closeDivModal(); });

$('#addDivSetBtn').addEventListener('click', ()=>{
  if (FORM_MODE==='view'){ alert('ë³´ê¸° ëª¨ë“œì…ë‹ˆë‹¤. ìƒë‹¨ [ìˆ˜ì •]ìœ¼ë¡œ ì „í™˜í•˜ì„¸ìš”.'); return; }
  openDivModal((group, divs)=>{
    // ê°™ì€ ê·¸ë£¹ rowê°€ ìˆìœ¼ë©´ ë³‘í•©, ì—†ìœ¼ë©´ ìƒˆë¡œ
    const rows = [...document.querySelectorAll('#divSetList .place-item')];
    const same = rows.find(r => r.querySelector('div > b')?.textContent === group);
    if (same && same.addDivisions){ same.addDivisions(group, divs); }
    else {
      const r = makeDivSetRow({group, divisions:divs});
      $('#divSetList').appendChild(r);
      setDirty();
    }
  });
});

/* ================== ì£¼ì†Œê²€ìƒ‰ (í–‰ì•ˆë¶€ íŒì—… + ì½œë°± ì „ìš© íŒŒì¼) ================== */
let addrPickTargetRow = null;
function openJusoPopup(targetRow=null){
  if (FORM_MODE==='view'){ alert('ë³´ê¸° ëª¨ë“œì…ë‹ˆë‹¤. ìƒë‹¨ [ìˆ˜ì •]ìœ¼ë¡œ ì „í™˜í•˜ì„¸ìš”.'); return; }
  addrPickTargetRow = targetRow;
  const returnUrl = location.origin + '/juso-callback.html'; // 404 ë°©ì§€: ê³ ì • ì½œë°± íŒŒì¼
  const url = `https://www.juso.go.kr/addrlink/addrLinkUrl.do?confmKey=${encodeURIComponent(JUSO_KEY)}&returnUrl=${encodeURIComponent(returnUrl)}&resultType=4`;
  window.open(url,'jusoPopup','width=570,height=420,scrollbars=yes,resizable=yes');
}
window.__onJusoSelected = function(d){
  const v = {
    name: d.bdNm || d.roadAddr || d.roadAddrPart1 || '',
    address: d.roadAddr || [d.roadAddrPart1||'', d.roadAddrPart2||''].join(' ').trim(),
    lat: parseFloat(d.entY||''), lng: parseFloat(d.entX||'')
  };
  if (addrPickTargetRow){ fillPlaceRow(addrPickTargetRow, v); }
  else { const row = makePlaceRow({}); $('#placeList').appendChild(row); fillPlaceRow(row, v); }
  addrPickTargetRow = null; setDirty();
};

function makePlaceRow(init={ name:'', address:'', lat:'', lng:'' }){
  const row = el(`<div class="place-item"></div>`);
  const name = el(`<div><b>ì¥ì†Œ</b></div>`);
  const addr = el(`<div class="chips"></div>`);
  const ctrl = el(`<div style="display:flex;gap:6px;align-items:center">
    <button class="btn" data-research>ê²€ìƒ‰</button>
    <button class="btn danger" data-del>ì‚­ì œ</button>
  </div>`);
  ctrl.querySelector('[data-research]').addEventListener('click', ()=> openJusoPopup(row));
  ctrl.querySelector('[data-del]').addEventListener('click', ()=>{ setDirty(); row.remove(); });

  row.appendChild(name); row.appendChild(addr); row.appendChild(ctrl);

  row.getValue = ()=>{
    const a = addr.dataset.addr||''; const lat=parseFloat(addr.dataset.lat||''), lng=parseFloat(addr.dataset.lng||'');
    return { name: name.dataset.name||'', address:a, lat, lng };
  };
  return row;
}
function fillPlaceRow(row,v){
  const [nameCell, addrCell] = row.children;
  nameCell.innerHTML = `<b>${v.name||'ì¥ì†Œ'}</b>`;
  nameCell.dataset.name = v.name||'';
  addrCell.className = 'chips';
  addrCell.dataset.addr = v.address||'';
  addrCell.dataset.lat  = isFinite(v.lat)?Number(v.lat).toFixed(6):'';
  addrCell.dataset.lng  = isFinite(v.lng)?Number(v.lng).toFixed(6):'';
  addrCell.innerHTML = `
    <span class="chip">${v.address||'-'}</span>
    ${isFinite(v.lat)&&isFinite(v.lng)?`<span class="chip">ìœ„ë„ ${Number(v.lat).toFixed(6)}</span><span class="chip">ê²½ë„ ${Number(v.lng).toFixed(6)}</span>`:''}
  `;
}
function getPlaces(){ return [...document.querySelectorAll('#placeList .place-item')].map(it=> it.getValue()).filter(p=>p.name||p.address||(p.lat&&p.lng)); }
function setPlaces(list){ const box=$('#placeList'); box.innerHTML=''; (list&&list.length?list:[]).forEach(v=>{ const r=makePlaceRow({}); box.appendChild(r); fillPlaceRow(r, v); }); }
$('#addPlaceBtn').addEventListener('click', ()=> openJusoPopup(null));

/* ================== í¼ ë¡œë“œ/ì´ˆê¸°í™” ================== */
function updateStatusBadge(){ $('#tourStatusBadge').innerHTML = statusBadgeHtml( calcStatus($('#regStart').value||'', $('#regEnd').value||'') ); }
['tourName','tourUrl','tourStart','tourEnd','regStart','regEnd','adminCode'].forEach(id=> $('#'+id).addEventListener('input', setDirty));

function loadTourToForm(t){
  $('#tourFormTitle').textContent = 'ëŒ€íšŒ ë³´ê¸°';
  $('#tourId').value   = t.TourID || '';
  $('#tourName').value = t.name || '';
  $('#tourUrl').value  = t.url || '';

  // ë‚ ì§œ/ì‹œê°„ â€” ë¬¸ìì—´ ê·¸ëŒ€ë¡œ ìœ ì§€ (ì„œë²„ê°€ ì–´ë–¤ í¬ë§·ì„ ì£¼ë”ë¼ë„ ë°”ë€Œì§€ ì•Šê²Œ)
  const startRaw = t.start_str || t.startDate || t.start;
  const endRaw   = t.end_str   || t.endDate   || t.end;
  const rsRaw    = t.regStart_str || t.regStartLocal || t.regStart;
  const reRaw    = t.regEnd_str   || t.regEndLocal   || t.regEnd;

  $('#tourStart').value = toInputDateOnly(startRaw);
  $('#tourEnd').value   = toInputDateOnly(endRaw);
  $('#regStart').value  = toInputDT(rsRaw);
  $('#regEnd').value    = toInputDT(reRaw);
  updateStatusBadge();

  // ì¢…ë³„: ì¹©ë§Œ
  let divSets = Array.isArray(t.divSets)&&t.divSets.length ? t.divSets
              : Object.keys(t.divs||{}).map(g=>({group:g,divisions:t.divs[g]}));
  setDivSets(divSets);

  // ì¥ì†Œ
  setPlaces(Array.isArray(t.places)?t.places:[]);

  // ë³´ê¸°ëª¨ë“œ
  $('#adminCode').value = '';
  setMode('view');
}
function clearTourForm(){
  $('#tourFormTitle').textContent = 'ì‹ ê·œ ëŒ€íšŒ';
  ['tourId','tourName','tourUrl','tourStart','tourEnd','regStart','regEnd','adminCode'].forEach(id=> $('#'+id).value='');
  setDivSets([{group:'ì¼ë°˜ë¶€',divisions:[]}]);
  setPlaces([]);
  updateStatusBadge();
  setMode('new');
  setDirty();
}

/* ================== ì €ì¥/ì‚­ì œ ================== */
$('#toggleCodeBtn').addEventListener('click', ()=>{ const i=$('#adminCode'); i.type = i.type==='password' ? 'text' : 'password'; });

async function saveTournament(){
  const name=($('#tourName').value||'').trim(); if(!name) return alert('ëŒ€íšŒëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
  const adminCode=($('#adminCode').value||'').trim(); if(!adminCode) return alert('ê´€ë¦¬ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

  const divSets=getDivSets().map(s=>({group:s.group,divisions:(s.divisions||[])}));
  const divs={}; divSets.forEach(s=>{ if(!divs[s.group]) divs[s.group]=[]; (s.divisions||[]).forEach(d=>{ if(!divs[s.group].includes(d)) divs[s.group].push(d); }); });

  const payload={
    tourId: ($('#tourId').value||'').trim(),
    name,
    start:   $('#tourStart').value || '',
    end:     $('#tourEnd').value   || '',
    regStart:$('#regStart').value  || '',
    regEnd:  $('#regEnd').value    || '',
    status:   calcStatus($('#regStart').value||'', $('#regEnd').value||''),
    url:($('#tourUrl').value||'').trim(),
    divSets, divs,
    places:getPlaces(),
    adminCode
  };

  const j=await postJSON('upsertTournament', payload);
  if(!j.ok) return alert('ì €ì¥ ì‹¤íŒ¨: '+(j.error||'unknown'));

  await loadTournaments();
  if(j.tourId) $('#tourId').value = j.tourId;
  resetDirty();
  alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  setMode('view'); // ì €ì¥ í›„ ë³´ê¸°ëª¨ë“œë¡œ
}

$('#saveTourBtn').addEventListener('click', async ()=>{
  try{ await saveTournament(); }catch(e){ alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜: '+e.message); }
});

$('#deleteTourBtn').addEventListener('click', async ()=>{
  const id=($('#tourId').value||'').trim(); if(!id) return alert('ì‚­ì œí•  ëŒ€íšŒê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
  if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
  const code2 = prompt('ëŒ€íšŒê´€ë¦¬ ì½”ë“œë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”:',''); if(!code2) return alert('ê´€ë¦¬ì½”ë“œë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
  try{
    const j=await postJSON('removeTournament', { tourId:id, adminCode:code2 });
    if(!j.ok) return alert('ì‚­ì œ ì‹¤íŒ¨: '+(j.error||'unknown'));
    clearTourForm(); await loadTournaments(); alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
  }catch(e){ alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜: '+e.message); }
});

/* ================== ìƒë‹¨ ë²„íŠ¼/ì´ë²¤íŠ¸ ================== */
$('#settingsBtn').addEventListener('click', ()=>{
  const cur=(conf.appUrl||'').trim();
  const val=prompt('Apps Script Web App URLì„ ì…ë ¥í•˜ì„¸ìš”:', cur);
  if(val===null) return; conf.appUrl=(val||'').trim(); store.save(conf);
  alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.'); location.reload();
});

$('#reloadBtn').addEventListener('click', async ()=>{
  if (!guardUnsaved()) return;
  await health(); await loadTournaments(); await loadTeams();
});

$('#newTourBtn').addEventListener('click', ()=>{
  if (!guardUnsaved()) return;
  clearTourForm(); // ëª¨ë“œ new + dirty true
});

$('#editBtn').addEventListener('click', ()=>{
  if (!($('#tourId').value||'').trim()) return alert('ë¨¼ì € ëŒ€íšŒë¥¼ ì„ íƒí•˜ì„¸ìš”.');
  if (!guardUnsaved()) return;
  const code = prompt('ì´ ëŒ€íšŒì˜ ê´€ë¦¬ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:','');
  if (!code) return;
  $('#adminCode').value = code;
  setMode('edit');
});

$('#tourFilter').addEventListener('change', ()=>{ if (guardUnsaved()) loadTeams(); });
$('#searchBtn').addEventListener('click', loadTeams);
$('#searchText').addEventListener('keydown', e=>{ if(e.key==='Enter') loadTeams(); });

/* ================== ë¶€íŠ¸ ================== */
(async function boot(){
  await health(); await loadTournaments(); await loadTeams();
  setMode('view'); // ì´ˆê¸° ë³´ê¸°ëª¨ë“œ
})();
</script>
</body>
</html>

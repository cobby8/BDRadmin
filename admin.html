<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BDR 관리자</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --blue:#1769ff; --bg:#f6f8fb; --card:#fff; --muted:#6b7684; --red:#ef4444; --green:#16a34a }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:'Pretendard','Apple SD Gothic Neo',sans-serif;color:#222}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px 64px}
  header{display:flex;justify-content:space-between;align-items:center;margin:10px 0 18px}
  h1{font-size:20px;margin:0}
  .card{background:var(--card);border-radius:14px;box-shadow:0 8px 28px rgba(23,105,255,.08);padding:16px;margin-top:16px}
  .row{display:grid;gap:12px}
  @media(min-width:720px){ .row-2{grid-template-columns:1.2fr 2fr} .row-3{grid-template-columns:1fr 1fr 1fr} }
  label{display:block;font-weight:600;margin:10px 0 6px}
  input,select,textarea{width:100%;padding:12px;border:1px solid #e6ecf5;border-radius:12px;font-size:14px;outline:none;background:#fff}
  input:focus,select:focus,textarea:focus{border-color:var(--blue)}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid #dfe6ee;background:#fff;cursor:pointer}
  .btn.primary{background:var(--blue);color:#fff;border-color:var(--blue)}
  .btn.danger{background:#fff;color:var(--red);border-color:#ffd1d1}
  .btn.ghost{background:#fff;color:#334155;border-color:#e6ecf5}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted);font-size:12px}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  th{font-size:12px;color:#5b6472;text-align:left;padding:0 10px}
  td{background:#fff;padding:12px 10px;border-top:1px solid #eef2f7;border-bottom:1px solid #eef2f7}
  tr td:first-child{border-left:1px solid #eef2f7;border-radius:12px 0 0 12px}
  tr td:last-child{border-right:1px solid #eef2f7;border-radius:0 12px 12px 0}
  .badge{display:inline-flex;gap:6px;align-items:center;font-size:12px;color:#334155;background:#f1f5fb;border:1px solid #e4ecf7;border-radius:999px;padding:4px 8px}
  .right{display:flex;justify-content:flex-end}
  .w-140{width:140px}
  .jersey{display:inline-flex;align-items:center;gap:6px}
  .searchbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-block;border:1px solid #e6ecf5;border-radius:999px;padding:6px 10px;font-size:12px;margin:2px 0;background:#fff}
  .grid{display:grid;gap:10px}
  .grid-2{grid-template-columns:1fr 1fr}
  .grid-3{grid-template-columns:1fr 1fr 1fr}
  .help{font-size:12px;color:#6b7280}
  .section-title{font-weight:700;margin:16px 0 6px}
  .subtle{font-size:13px;color:#475569;margin-top:-6px}
  .place-item{display:grid;gap:8px;grid-template-columns:1.2fr 2fr .9fr .9fr auto;align-items:center;border:1px solid #e6ecf5;border-radius:12px;padding:10px;background:#fff}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px solid #e6ecf5;border-radius:999px;padding:6px 10px;font-size:12px;background:#fff;cursor:pointer}
  .list{display:grid;gap:10px}
  .hr{height:1px;background:#eef2f7;margin:8px 0}
  /* 종별 드롭다운 */
  .dd{position:relative}
  .dd-toggle{width:100%}
  .dd-panel{position:absolute;top:calc(100% + 6px);left:0;background:#fff;border:1px solid #e6ecf5;border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.12);z-index:1000;padding:10px;min-width:260px;max-width:360px}
  .dd-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;max-height:180px;overflow:auto;margin:6px 0}
  .dd-actions{display:flex;gap:8px;justify-content:flex-end}
  /* 관리코드 아이콘 */
  .input-icon{position:relative}
  .eye-btn{position:absolute;right:10px;top:50%;transform:translateY(-50%);border:0;background:transparent;cursor:pointer;font-size:16px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>BDR 관리자</h1>
    <div class="toolbar">
      <span class="muted" id="healthDot">●</span>
      <button class="btn" id="settingsBtn">⚙️ 설정</button>
      <button class="btn" id="reloadBtn">새로고침</button>
    </div>
  </header>

  <!-- 대회 필터 -->
  <div class="card">
    <div class="row row-3">
      <div>
        <label>대회 필터</label>
        <select id="tourFilter"><option value="">전체 대회</option></select>
      </div>
      <div class="muted" style="align-self:end">※ ⚙️에서 Apps Script URL과 승인키를 확인/변경할 수 있습니다.</div>
    </div>
  </div>

  <!-- 대회 관리 -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0;font-size:16px">대회 관리</h3>
      <div class="toolbar">
        <button class="btn" id="newTourBtn">신규 대회</button>
      </div>
    </div>

    <div class="row row-2">
      <!-- 좌: 대회 목록 -->
      <div>
        <label>대회 목록</label>
        <div id="tourList" class="grid"></div>
      </div>

      <!-- 우: 대회 등록/수정 -->
      <div>
        <label id="tourFormTitle">대회 등록/수정</label>

        <!-- 1) 기본정보 -->
        <div class="grid">
          <input id="tourId" placeholder="자동생성 (수정 시 고정)" disabled>
          <input id="tourName" placeholder="대회명">
          <input id="tourUrl" placeholder="안내 페이지 URL (선택)">
        </div>

        <!-- 2) 종별(구분/종별) : 드롭다운(체크박스) -->
        <div class="section-title">종별 설정</div>
        <div class="subtle">구분을 선택하고 <b>종별</b> 드롭다운을 열어 여러 항목을 체크 → 적용하세요. 칩을 클릭하면 제거됩니다.</div>
        <div id="divSetList" class="list" style="margin-top:8px"></div>
        <div class="toolbar" style="margin-top:6px">
          <button class="btn ghost" id="addDivSetBtn">+ 구분/종별 추가</button>
        </div>

        <div class="hr"></div>

        <!-- 3) 대회장소(복수) : 행안부 주소검색 팝업 -->
        <div class="section-title">대회장소</div>
        <div class="subtle">우측 <b>+ 장소 추가</b>를 누르면 <b>행정안전부 주소검색 팝업</b>이 열립니다. 결과에서 선택하면 행이 추가됩니다.</div>
        <div id="placeList" class="list" style="margin-top:8px"></div>
        <div class="toolbar" style="margin-top:6px;justify-content:flex-end">
          <button class="btn ghost" id="addPlaceBtn">+ 장소 추가</button>
        </div>

        <div class="hr"></div>

        <!-- 4-1) 대회기간 -->
        <div class="section-title">대회기간</div>
        <div class="grid grid-2">
          <input id="tourStart" type="date" placeholder="시작일">
          <input id="tourEnd" type="date" placeholder="종료일">
        </div>
        <div class="help" style="margin-top:4px">대회가 열리는 날짜 구간입니다.</div>

        <!-- 4-2) 접수기간 -->
        <div class="section-title" style="margin-top:14px">접수기간</div>
        <div class="grid grid-2">
          <input id="regStart" type="datetime-local" placeholder="접수 시작">
          <input id="regEnd" type="datetime-local" placeholder="접수 종료">
        </div>
        <div class="help" style="margin-top:4px">참가신청 접수 가능 시간입니다. (날짜+시간)</div>

        <!-- 5) 보안(관리코드) + 상태(자동) + 저장 -->
        <div class="grid grid-2" style="margin-top:12px;align-items:end">
          <div>
            <label>대회관리 코드 (필수)</label>
            <div class="input-icon">
              <input id="adminCode" type="password" placeholder="이 대회를 관리할 비밀번호">
              <button class="eye-btn" id="toggleCodeBtn" title="보기/숨기기">👁️</button>
            </div>
            <div class="help">신규 생성 시 설정, 이후 수정/삭제 시 동일 코드 필요.</div>
            <div style="margin-top:8px">
              <label>상태(자동)</label>
              <div id="tourStatusBadge" class="badge">상태미정</div>
              <div class="help">접수기간에 따라 자동 표시(접수전/접수중/마감). 관리자 수동 변경 불가.</div>
            </div>
          </div>
          <div class="toolbar" style="justify-content:flex-end;gap:8px">
            <button class="btn danger" id="deleteTourBtn">삭제</button>
            <button class="btn primary" id="saveTourBtn">저장</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 팀/선수 -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0;font-size:16px">팀 / 선수</h3>
      <div class="searchbar">
        <input id="searchText" placeholder="팀명/대표자/연락처 검색" class="w-140">
        <button class="btn" id="searchBtn">검색</button>
      </div>
    </div>

    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>팀ID</th>
            <th>대회</th>
            <th>지역</th>
            <th>팀명 / 대표</th>
            <th>종별·디비전</th>
            <th>유니폼</th>
            <th>신청일시</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="teamsTbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ================== 상수 / 설정 ================== */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz1qk5MbQvVU3d8Qs3EcPO792iBNlVQR71WhCpNbkqzCcdn5gM17Hqx9AUAIGUwwSKCww/exec';
const APPLY_BASE  = 'https://bdrjoin.netlify.app/';
const JUSO_KEY    = 'U01TX0FVVEgyMDI1MDkwOTIzNTcyMjExNjE2NDQ='; // 행안부 팝업 API 승인키

const store = {
  key: 'BDR_ADMIN_CONF',
  load(){ try { return JSON.parse(localStorage.getItem(this.key) || '{}'); } catch { return {} } },
  save(obj){ localStorage.setItem(this.key, JSON.stringify(obj||{})); }
};
const conf = store.load();
if (!conf.appUrl && WEB_APP_URL) { conf.appUrl = WEB_APP_URL; store.save(conf); }

const $ = s => document.querySelector(s);
const el = html => { const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstElementChild; };

/* ===== 행안부 팝업 선택 결과(리턴 페이지) 처리 가드 =====
   팝업의 returnUrl을 이 페이지로 지정해도, 팝업 창 안에서만 실행되고
   opener.__onJusoSelected(...) 호출 후 즉시 닫힙니다. */
(function maybeJusoReturn(){
  const p = new URLSearchParams(location.search);
  if (p.get('inputYn') === 'Y' && window.opener && window.opener.__onJusoSelected){
    const data = Object.fromEntries(p.entries());
    window.opener.__onJusoSelected(data);
    setTimeout(()=> window.close(), 0);
  }
})();

/* ================== 일반 유틸 ================== */
function apiUrl(path, q={}){
  const base = (conf.appUrl||'').trim();
  if (!base) throw new Error('Web App URL이 설정되지 않았습니다. 우상단 ⚙️에서 설정하세요.');
  let u = new URL(base);
  u.searchParams.set('path', path);
  Object.entries(q).forEach(([k,v])=> u.searchParams.set(k, v));
  return u.toString();
}
async function getJSON(u){ const r = await fetch(u); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
async function postJSON(path, payload){
  const r = await fetch(apiUrl(path), { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(payload||{}) });
  if (!r.ok) throw new Error('HTTP '+r.status);
  return r.json();
}
async function health(){
  try{ const j = await getJSON(apiUrl('health')); $('#healthDot').style.color = j.ok ? '#22c55e' : '#ef4444'; }
  catch{ $('#healthDot').style.color = '#ef4444'; }
}
function pad(n){ return String(n).padStart(2,'0'); }
function toLocalDT(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function toInputDateOnly(src){
  if(!src) return ''; if(typeof src==='string'){ const m=src.match(/^(\d{4}-\d{2}-\d{2})/); if(m) return m[1]; }
  const d=new Date(src); if(!isNaN(d)) return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; return '';
}
function toInputDT(src){
  if(!src) return ''; if(typeof src==='string'){ const m=src.match(/^(\d{4}-\d{2}-\d{2})[ T](\d{2}):(\d{2})/); if(m) return `${m[1]}T${m[2]}:${m[3]}`; }
  const d=new Date(src); if(!isNaN(d)) return toLocalDT(d); return '';
}
function fmtDate(v){
  if(!v) return ''; const d=new Date(v); if(isNaN(d)) return String(v);
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function calcStatus(regStart, regEnd){
  if (!regStart || !regEnd) return '상태미정';
  const s=new Date(regStart), e=new Date(regEnd), now=new Date();
  if(isNaN(s)||isNaN(e)) return '상태미정';
  if(now<s) return '접수전'; if(now>e) return '마감'; return '접수중';
}
function statusBadgeHtml(status){
  const c={ '접수중':{bg:'#ecfdf5',bd:'#d1fae5',fg:'#16a34a'}, '접수전':{bg:'#eff6ff',bd:'#dbeafe',fg:'#1769ff'}, '마감':{bg:'#fef2f2',bd:'#fee2e2',fg:'#ef4444'}, '상태미정':{bg:'#f1f5fb',bd:'#e4ecf7',fg:'#334155'} }[status] || {bg:'#f1f5fb',bd:'#e4ecf7',fg:'#334155'};
  return `<span class="badge" style="background:${c.bg};border-color:${c.bd};color:${c.fg}">${status}</span>`;
}

/* ================== 대회 목록/필터 ================== */
let TOURS = {}, TOUR_ARRAY = [];
async function loadTournaments(){
  const j = await getJSON(apiUrl('tournaments'));
  TOURS = {}; TOUR_ARRAY = j.rows || [];
  TOUR_ARRAY.forEach(t => TOURS[t.TourID] = t);
  renderTournamentList(); renderTourFilter();
}
function renderTournamentList(){
  const box = $('#tourList');
  box.innerHTML = (TOUR_ARRAY||[]).map(t=>{
    const range = (t.start||t.end) ? `${fmtDate(t.start)} ~ ${fmtDate(t.end)}` : '일정미정';
    const stat = calcStatus(t.regStart, t.regEnd);
    return `<div class="pill" data-id="${t.TourID}"><b>${t.name}</b> · ${stat} · ${range}</div>`;
  }).join('');
  box.querySelectorAll('.pill').forEach(el=> el.addEventListener('click', ()=> loadTourToForm(TOURS[el.dataset.id])));
}
function renderTourFilter(){
  const sel=$('#tourFilter'); const cur=sel.value;
  sel.innerHTML='<option value="">전체 대회</option>';
  TOUR_ARRAY.forEach(t=>{ const o=document.createElement('option'); o.value=t.TourID; o.textContent=t.name; sel.appendChild(o); });
  if(TOUR_ARRAY.find(x=>x.TourID===cur)) sel.value=cur;
}

/* ================== 팀 표 ================== */
function jerseySVG(hex, label){
  const color=(/^#[0-9a-f]{6}$/i).test(hex||'')?hex:'#e5e7eb', text=(label||'').toUpperCase();
  return `<svg width="42" height="52" viewBox="0 0 42 52" xmlns="http://www.w3.org/2000/svg"><g filter="url(#s)">
  <path d="M14 3 l4 6 h6 l4-6 h6 v15 l3 3 v27 a3 3 0 0 1 -3 3 h-26 a3 3 0 0 1 -3 -3 v-27 l3-3 v-15 z" fill="${color}" stroke="#cbd5e1"/>
  <text x="21" y="31" font-family="system-ui,sans-serif" font-size="9" fill="#0f172a" text-anchor="middle" font-weight="700">${text}</text>
</g><defs><filter id="s" x="0" y="0" width="42" height="52"><feDropShadow dx="0" dy="1" stdDeviation="1" flood-color="#000" flood-opacity=".08"/></filter></defs></svg>`;
}
function normalizeTeamRow(r){
  const region=[r.시도||r.province||'', r.시군구||r.city||''].join(' ').trim();
  const cat=r.종별||r.category||'', div=r.디비전||r.division||'';
  function pickHex(p,f){ if(typeof p==='string' && /^#[0-9a-f]{6}$/i.test(p)) return p.toLowerCase(); if(typeof f==='string'){ const m=f.match(/#([0-9a-f]{6})/i); if(m) return('#'+m[1]).toLowerCase(); } return ''; }
  const homeHex=pickHex(r.uniformHomeHex, r['유니폼(홈)']), awayHex=pickHex(r.uniformAwayHex, r['유니폼(어웨이)']);
  return {teamId:r.TeamID||r.teamId||'', tourId:(r.TourID||r.tourId||'').toString().trim(), tourName:r.tourName||r.TourName||r['대회명']||'', region, teamName:r.팀명||r.teamName||'', managerName:r.대표자이름||r.managerName||'', managerPhone:r.대표자연락처||r.managerPhone||'', category:cat, division:div, homeHex, awayHex, createdAt:r.신청일시||r.createdAt||'', editCode:r.수정코드||r.editCode||'' };
}
function rowTeam(v){
  return `<tr><td>${v.teamId}</td><td>${v.tourName||'-'}</td><td>${v.region||'-'}</td>
  <td><div><b>${v.teamName||''}</b></div><div class="muted">${v.managerName||''} · ${v.managerPhone||''}</div></td>
  <td>${v.category||''} · ${v.division||''}</td>
  <td><div class="jersey">${jerseySVG(v.homeHex,'HOME')}${jerseySVG(v.awayHex,'AWAY')}</div></td>
  <td>${fmtDate(v.createdAt)}</td>
  <td class="right"><a class="btn" href="${editUrlFor(v.teamId, v.editCode)}" target="_blank" rel="noopener">수정 열기</a></td></tr>`;
}
function editUrlFor(teamId, editCode){ const base=APPLY_BASE.replace(/index\.html$/,''); const sep=base.endsWith('/')?'':'/'; return `${base}${sep}?edit=${encodeURIComponent(teamId)}&code=${encodeURIComponent(editCode||'')}`; }
async function loadTeams(){
  try{
    const tourId=($('#tourFilter').value||'').trim();
    const j=await getJSON(apiUrl('teams', tourId?{tourId}:{}) );
    let rows=Array.isArray(j.rows)?j.rows:[]; if(tourId) rows=rows.filter(r=>String(r.TourID||r.tourId||'').trim()===tourId);
    const q=($('#searchText').value||'').trim().toLowerCase();
    if(q){ rows=rows.filter(r=>{ const v=normalizeTeamRow(r); return [v.teamId,v.tourName,v.region,v.teamName,v.managerName,v.managerPhone,v.category,v.division].join(' ').toLowerCase().includes(q); }); }
    $('#teamsTbody').innerHTML = rows.map(r=>rowTeam(normalizeTeamRow(r))).join('') || `<tr><td colspan="8" class="muted">데이터 없음</td></tr>`;
  }catch(e){ $('#teamsTbody').innerHTML = `<tr><td colspan="8" class="muted">불러오기 오류: ${e.message}</td></tr>`; }
}

/* ================== 종별(구분/종별): 드롭다운 체크박스 ================== */
const DIVISION_PRESETS = { '일반부':['D3','D4','D5','D6','D7'], '대학부':['U1','U2','U3','UW'], '여성부':['D3','D4','D5'], '유소년부':['하모니','i1','i2','i3','i4'] };

function makeDivSetRow(init={ group:'일반부', divisions:[] }){
  const row = el(`<div class="place-item"></div>`);

  // 구분
  const groupWrap = el(`<div><label style="margin:0 0 6px">구분</label></div>`);
  const groupSel  = el(`<select class="groupSel">${Object.keys(DIVISION_PRESETS).map(g=>`<option value="${g}">${g}</option>`).join('')}</select>`);
  groupWrap.appendChild(groupSel);

  // 종별 드롭다운(체크박스)
  const ddWrap = el(`<div><label style="margin:0 0 6px">종별</label></div>`);
  const dd     = el(`<div class="dd"></div>`);
  const ddBtn  = el(`<button class="btn dd-toggle" type="button">종별 선택 ▾</button>`);
  const panel  = el(`<div class="dd-panel" style="display:none"></div>`);
  const listBox= el(`<div class="dd-row"></div>`);
  const actions= el(`<div class="dd-actions"><button class="btn" data-apply>적용</button><button class="btn" data-close>닫기</button></div>`);
  panel.appendChild(listBox); panel.appendChild(actions); dd.appendChild(ddBtn); dd.appendChild(panel); ddWrap.appendChild(dd);

  function renderCheckboxes(){
    const opts=DIVISION_PRESETS[groupSel.value]||[];
    listBox.innerHTML=opts.map(v=>{
      const id='cb_'+groupSel.value+'_'+v+'_'+Math.random().toString(36).slice(2,7);
      return `<label style="display:flex;gap:6px;align-items:center;border:1px solid #e6ecf5;border-radius:999px;padding:6px 10px"><input type="checkbox" value="${v}" id="${id}"><span>${v}</span></label>`;
    }).join('');
  }
  function openPanel(){ panel.style.display='block'; document.addEventListener('click', outsideClose, {once:true}); }
  function closePanel(){ panel.style.display='none'; }
  function outsideClose(ev){ if(!panel.contains(ev.target) && ev.target!==ddBtn) closePanel(); }

  ddBtn.addEventListener('click', (e)=>{ e.stopPropagation(); panel.style.display==='none'?openPanel():closePanel(); });
  panel.querySelector('[data-close]').addEventListener('click', closePanel);

  // 선택 결과 칩
  const tags = el(`<div><label style="margin:0 0 6px">선택 결과</label><div class="chips"></div></div>`);
  const chipsBox = tags.querySelector('.chips');
  let values = Array.from(init.divisions||[]);
  function refreshChips(){
    chipsBox.innerHTML = values.length ? values.map(v=>`<span class="chip" data-v="${v}" title="클릭하여 제거">${v} ×</span>`).join('') : '<span class="muted" style="padding:6px 0">미선택</span>';
    chipsBox.querySelectorAll('.chip').forEach(c=> c.addEventListener('click',()=>{ const v=c.getAttribute('data-v'); values=values.filter(x=>x!==v); refreshChips(); }) );
  }
  panel.querySelector('[data-apply]').addEventListener('click', ()=>{
    const checked=[...panel.querySelectorAll('input[type="checkbox"]:checked')].map(i=>i.value);
    checked.forEach(v=>{ if(!values.includes(v)) values.push(v); });
    panel.querySelectorAll('input[type="checkbox"]').forEach(i=> i.checked=false);
    refreshChips(); closePanel();
  });

  // 삭제 버튼
  const del = el(`<div style="display:flex;align-items:flex-end;gap:8px;justify-content:flex-end"><button class="btn danger">삭제</button></div>`);
  del.querySelector('button').addEventListener('click', ()=> row.remove());

  // 초기화
  groupSel.value = init.group || '일반부';
  renderCheckboxes(); refreshChips();
  groupSel.addEventListener('change', renderCheckboxes);

  row.appendChild(groupWrap);
  row.appendChild(ddWrap);
  row.appendChild(tags);
  row.appendChild(el('<div></div>'));
  row.appendChild(del);

  row.getValue = ()=>({ group: groupSel.value, divisions: values.slice() });
  return row;
}
function getDivSets(){ return [...document.querySelectorAll('#divSetList .place-item')].map(it=>it.getValue()); }
function setDivSets(list){ const box=$('#divSetList'); box.innerHTML=''; (list&&list.length?list:[{group:'일반부',divisions:[]}]).forEach(v=> box.appendChild(makeDivSetRow(v))); }
$('#addDivSetBtn').addEventListener('click', ()=> $('#divSetList').appendChild(makeDivSetRow()) );

/* ================== 행안부 주소검색 팝업 ================== */
let addrPickTargetRow = null;
function openJusoPopup(targetRow=null){
  addrPickTargetRow = targetRow;
  const returnUrl = location.origin + location.pathname; // 이 페이지가 콜백 처리
  const url = `https://www.juso.go.kr/addrlink/addrLinkUrl.do?confmKey=${encodeURIComponent(JUSO_KEY)}&returnUrl=${encodeURIComponent(returnUrl)}&resultType=4`;
  window.open(url,'jusoPopup','width=570,height=420,scrollbars=yes,resizable=yes');
}
window.__onJusoSelected = function(d){
  // d.roadAddr / d.roadAddrPart1 / d.roadAddrPart2 / d.bdNm / d.entX(경도) / d.entY(위도) …
  const v = {
    name: d.bdNm || d.roadAddr || d.roadAddrPart1 || '',
    address: d.roadAddr || [d.roadAddrPart1||'', d.roadAddrPart2||''].join(' ').trim(),
    lat: parseFloat(d.entY||''),
    lng: parseFloat(d.entX||'')
  };
  if (addrPickTargetRow){
    fillPlaceRow(addrPickTargetRow, v);
  }else{
    const row = makePlaceRow({});
    $('#placeList').appendChild(row);
    fillPlaceRow(row, v);
  }
  addrPickTargetRow = null;
};

function makePlaceRow(init={ name:'', address:'', lat:'', lng:'' }){
  const row = el(`<div class="place-item"></div>`);
  const name = el(`<div><label style="margin:0 0 6px">장소명</label><input value="${init.name||''}" placeholder="예: 서울대학교 종합체육관"></div>`);
  const addr = el(`<div><label style="margin:0 0 6px">주소</label><input value="${init.address||''}" placeholder="팝업으로 입력하세요"></div>`);
  const lat  = el(`<div><label style="margin:0 0 6px">위도</label><input value="${init.lat||''}" placeholder="37.xxxxxx"></div>`);
  const lng  = el(`<div><label style="margin:0 0 6px">경도</label><input value="${init.lng||''}" placeholder="126.xxxxxx"></div>`);
  const ctrl = el(`<div style="display:flex;gap:6px;align-items:flex-end"><button class="btn" data-research>재검색</button><button class="btn danger" data-del>삭제</button></div>`);
  ctrl.querySelector('[data-research]').addEventListener('click', ()=> openJusoPopup(row));
  ctrl.querySelector('[data-del]').addEventListener('click', ()=> row.remove());
  row.appendChild(name); row.appendChild(addr); row.appendChild(lat); row.appendChild(lng); row.appendChild(ctrl);
  row.getValue = ()=>({ name:name.querySelector('input').value.trim(), address:addr.querySelector('input').value.trim(), lat:parseFloat(lat.querySelector('input').value), lng:parseFloat(lng.querySelector('input').value) });
  return row;
}
function fillPlaceRow(row,v){
  const [nameI, addrI, latI, lngI] = row.querySelectorAll('input');
  if (v.name) nameI.value = v.name;
  if (v.address) addrI.value = v.address;
  if (isFinite(v.lat)) latI.value = Number(v.lat).toFixed(6);
  if (isFinite(v.lng)) lngI.value = Number(v.lng).toFixed(6);
}
function getPlaces(){ return [...document.querySelectorAll('#placeList .place-item')].map(it=>it.getValue()).filter(p=>p.name||p.address||(p.lat&&p.lng)); }
function setPlaces(list){ const box=$('#placeList'); box.innerHTML=''; (list&&list.length?list:[]).forEach(v=> box.appendChild(makePlaceRow(v))); }
$('#addPlaceBtn').addEventListener('click', ()=> openJusoPopup(null));

/* ================== 폼 로드/초기화 ================== */
function updateStatusBadge(){ $('#tourStatusBadge').innerHTML = statusBadgeHtml( calcStatus($('#regStart').value||'', $('#regEnd').value||'') ); }
['regStart','regEnd'].forEach(id=> $('#'+id).addEventListener('change', updateStatusBadge));

function loadTourToForm(t){
  $('#tourFormTitle').textContent = '대회 수정';
  $('#tourId').value   = t.TourID || '';
  $('#tourName').value = t.name || '';
  $('#tourUrl').value  = t.url || '';

  // 날짜/시간 안전 파싱 (리셋 방지)
  $('#tourStart').value = toInputDateOnly(t.start);
  $('#tourEnd').value   = toInputDateOnly(t.end);
  $('#regStart').value  = toInputDT(t.regStart);
  $('#regEnd').value    = toInputDT(t.regEnd);
  updateStatusBadge();

  // 종별
  let divSets = t.divSets;
  if (!Array.isArray(divSets) || !divSets.length){
    const m=t.divs||{}; divSets=Object.keys(m).map(g=>({group:g,divisions:m[g]||[]}));
  }
  setDivSets(divSets);

  // 장소
  setPlaces(Array.isArray(t.places)?t.places:[]);

  // 보안
  $('#adminCode').value = ''; // 보안상 미리 채우지 않음
}
function clearTourForm(){
  $('#tourFormTitle').textContent = '대회 등록';
  ['tourId','tourName','tourUrl','tourStart','tourEnd','regStart','regEnd','adminCode'].forEach(id=> $('#'+id).value='');
  setDivSets([{group:'일반부',divisions:[]}]);
  setPlaces([]);
  updateStatusBadge();
}

/* ================== 저장/삭제 (관리코드) ================== */
$('#toggleCodeBtn').addEventListener('click', ()=>{
  const i=$('#adminCode'); i.type = i.type==='password' ? 'text' : 'password';
});

async function saveTournament(){
  const name=($('#tourName').value||'').trim(); if(!name) return alert('대회명을 입력하세요.');
  const adminCode=($('#adminCode').value||'').trim(); if(!adminCode) return alert('관리코드를 입력하세요.');

  const divSets=getDivSets().map(s=>({group:s.group,divisions:(s.divisions||[])}));
  const divs={}; divSets.forEach(s=>{ if(!divs[s.group]) divs[s.group]=[]; (s.divisions||[]).forEach(d=>{ if(!divs[s.group].includes(d)) divs[s.group].push(d); }); });

  const payload={
    tourId:($('#tourId').value||'').trim(),
    name,
    start: $('#tourStart').value || '',
    end:   $('#tourEnd').value   || '',
    regStart: $('#regStart').value || '',
    regEnd:   $('#regEnd').value   || '',
    status:   calcStatus($('#regStart').value||'', $('#regEnd').value||''),
    url:($('#tourUrl').value||'').trim(),
    divSets, divs,
    places:getPlaces(),
    adminCode // 신규=설정, 기존=검증
  };

  const j=await postJSON('upsertTournament', payload);
  if(!j.ok) return alert('저장 실패: '+(j.error||'unknown'));
  await loadTournaments();
  if(j.tourId) $('#tourId').value=j.tourId;
  alert('저장되었습니다.');
}
$('#saveTourBtn').addEventListener('click', async ()=>{ try{ await saveTournament(); }catch(e){ alert('저장 중 오류: '+e.message); } });

$('#deleteTourBtn').addEventListener('click', async ()=>{
  const id=($('#tourId').value||'').trim(); if(!id) return alert('삭제할 대회가 선택되지 않았습니다.');
  if(!confirm('정말 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) return;
  // 재확인용 관리코드 입력
  const code2 = prompt('대회관리 코드를 다시 입력하세요:','');
  if(!code2) return alert('관리코드가 입력되지 않았습니다.');
  try{
    const j=await postJSON('removeTournament', { tourId:id, adminCode: code2 });
    if(!j.ok) return alert('삭제 실패: '+(j.error||'unknown'));
    clearTourForm(); await loadTournaments(); alert('삭제되었습니다.');
  }catch(e){ alert('삭제 중 오류: '+e.message); }
});

/* ================== 상단 설정/검색/부트 ================== */
$('#settingsBtn').addEventListener('click', ()=>{
  const cur=(conf.appUrl||'').trim();
  const val=prompt('Apps Script Web App URL을 입력하세요:', cur);
  if(val===null) return; conf.appUrl=(val||'').trim(); store.save(conf);
  alert('설정이 저장되었습니다. 새로고침합니다.'); location.reload();
});
$('#reloadBtn').addEventListener('click', async ()=>{ await health(); await loadTournaments(); await loadTeams(); });
$('#tourFilter').addEventListener('change', loadTeams);
$('#searchBtn').addEventListener('click', loadTeams);
$('#searchText').addEventListener('keydown', e=>{ if(e.key==='Enter') loadTeams(); });

(async function boot(){
  if(!conf.appUrl){ alert('처음 사용이라면 ⚙️에서 Web App URL을 먼저 설정하세요.'); return; }
  await health(); await loadTournaments(); await loadTeams(); updateStatusBadge();
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BDR 관리자</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Leaflet (폴백 지도) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<style>
  :root{ --blue:#1769ff; --bg:#f6f8fb; --card:#fff; --muted:#6b7684; --red:#ef4444; --green:#16a34a }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:'Pretendard','Apple SD Gothic Neo',sans-serif;color:#222}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px 64px}
  header{display:flex;justify-content:space-between;align-items:center;margin:10px 0 18px}
  h1{font-size:20px;margin:0}
  .card{background:var(--card);border-radius:14px;box-shadow:0 8px 28px rgba(23,105,255,.08);padding:16px;margin-top:16px}
  .row{display:grid;gap:12px}
  @media(min-width:720px){ .row-2{grid-template-columns:1.2fr 2fr} .row-3{grid-template-columns:1fr 1fr 1fr} }
  label{display:block;font-weight:600;margin:10px 0 6px}
  input,select,textarea{width:100%;padding:12px;border:1px solid #e6ecf5;border-radius:12px;font-size:14px;outline:none;background:#fff}
  input:focus,select:focus,textarea:focus{border-color:var(--blue)}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid #dfe6ee;background:#fff;cursor:pointer}
  .btn.primary{background:var(--blue);color:#fff;border-color:var(--blue)}
  .btn.danger{background:#fff;color:var(--red);border-color:#ffd1d1}
  .btn.ghost{background:#fff;color:#334155;border-color:#e6ecf5}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted);font-size:12px}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  th{font-size:12px;color:#5b6472;text-align:left;padding:0 10px}
  td{background:#fff;padding:12px 10px;border-top:1px solid #eef2f7;border-bottom:1px solid #eef2f7}
  tr td:first-child{border-left:1px solid #eef2f7;border-radius:12px 0 0 12px}
  tr td:last-child{border-right:1px solid #eef2f7;border-radius:0 12px 12px 0}
  .badge{display:inline-flex;gap:6px;align-items:center;font-size:12px;color:#334155;background:#f1f5fb;border:1px solid #e4ecf7;border-radius:999px;padding:4px 8px}
  .right{display:flex;justify-content:flex-end}
  .w-140{width:140px}
  .jersey{display:inline-flex;align-items:center;gap:6px}
  .searchbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-block;border:1px solid #e6ecf5;border-radius:999px;padding:6px 10px;font-size:12px;margin:2px 0;background:#fff}
  .grid{display:grid;gap:10px}
  .grid-2{grid-template-columns:1fr 1fr}
  .grid-3{grid-template-columns:1fr 1fr 1fr}
  .help{font-size:12px;color:#6b7280}
  .section-title{font-weight:700;margin:16px 0 6px}
  .subtle{font-size:13px;color:#475569;margin-top:-6px}

  /* 지도 모달 */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
  .modal .panel{background:#fff;width:min(960px,96vw);max-height:90vh;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.18);display:flex;flex-direction:column}
  .modal .panel header{padding:12px 16px;border-bottom:1px solid #eef2f7}
  .modal .panel main{padding:12px 16px}
  #map{width:100%;height:420px;border-radius:12px;border:1px solid #e6ecf5}
  .place-item{display:grid;gap:8px;grid-template-columns:1.2fr 2fr .9fr .9fr auto;align-items:center;border:1px solid #e6ecf5;border-radius:12px;padding:10px;background:#fff}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px solid #e6ecf5;border-radius:999px;padding:6px 10px;font-size:12px;background:#fff;cursor:pointer}
  .list{display:grid;gap:10px}
  .hr{height:1px;background:#eef2f7;margin:8px 0}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>BDR 관리자</h1>
    <div class="toolbar">
      <span class="muted" id="healthDot">●</span>
      <button class="btn" id="settingsBtn">⚙️ 설정</button>
      <button class="btn" id="reloadBtn">새로고침</button>
    </div>
  </header>

  <!-- 대회 필터 -->
  <div class="card">
    <div class="row row-3">
      <div>
        <label>대회 필터</label>
        <select id="tourFilter"><option value="">전체 대회</option></select>
      </div>
      <div class="muted" style="align-self:end">※ 상단 ⚙️에서 Apps Script Web App URL과 지도 설정을 할 수 있습니다.</div>
    </div>
  </div>

  <!-- 대회 관리 -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0;font-size:16px">대회 관리</h3>
      <div class="toolbar">
        <button class="btn" id="newTourBtn">신규 대회</button>
      </div>
    </div>

    <div class="row row-2">
      <!-- 좌: 대회 목록 -->
      <div>
        <label>대회 목록</label>
        <div id="tourList" class="grid"></div>
      </div>

      <!-- 우: 대회 등록/수정 -->
      <div>
        <label id="tourFormTitle">대회 등록/수정</label>

        <!-- 1) 기본정보 -->
        <div class="grid">
          <input id="tourId" placeholder="자동생성 (수정 시 고정)" disabled>
          <input id="tourName" placeholder="대회명">
          <input id="tourUrl" placeholder="안내 페이지 URL (선택)">
        </div>

        <!-- 2) 종별(구분/종별) 빌더 -->
        <div class="section-title">종별 설정</div>
        <div class="subtle">구분을 선택하면 해당 구분의 종별 후보가 자동으로 표시됩니다. 한 대회에 복수의 구분/종별 세트를 추가할 수 있습니다.</div>
        <div id="divSetList" class="list" style="margin-top:8px"></div>
        <div class="toolbar" style="margin-top:6px">
          <button class="btn ghost" id="addDivSetBtn">+ 구분/종별 추가</button>
        </div>

        <div class="hr"></div>

        <!-- 3) 대회장소(복수) -->
        <div class="section-title">대회장소</div>
        <div class="subtle">⚙️에서 지도 제공자를 <b>naver</b>로 설정하고 <b>ncpClientId</b>를 입력하면 네이버 지도를 사용합니다. 키가 없으면 자동으로 Leaflet(OSM)로 동작합니다.</div>
        <div id="placeList" class="list" style="margin-top:8px"></div>
        <div class="toolbar" style="margin-top:6px">
          <button class="btn ghost" id="addPlaceBtn">+ 장소 추가</button>
        </div>

        <div class="hr"></div>

        <!-- 4) 기간 + 상태(자동) -->
        <div class="grid grid-2">
          <div>
            <label>대회기간</label>
            <div class="grid grid-2">
              <input id="tourStart" type="date" placeholder="시작일">
              <input id="tourEnd" type="date" placeholder="종료일">
            </div>
            <div class="help">대회가 열리는 날짜 구간입니다.</div>
          </div>
          <div>
            <label>접수기간</label>
            <div class="grid grid-2">
              <input id="regStart" type="datetime-local" placeholder="접수 시작">
              <input id="regEnd" type="datetime-local" placeholder="접수 종료">
            </div>
            <div class="help">참가신청 접수 가능 시간입니다. (날짜+시간)</div>
          </div>
        </div>

        <div class="grid grid-2" style="margin-top:8px;align-items:end">
          <div>
            <label>상태(자동)</label>
            <div id="tourStatusBadge" class="badge">상태미정</div>
            <div class="help">접수기간에 따라 자동 표시(접수전/접수중/마감). 관리자 수동 변경 불가.</div>
          </div>
          <div class="toolbar" style="justify-content:flex-end;gap:8px">
            <button class="btn danger" id="deleteTourBtn">삭제</button>
            <button class="btn primary" id="saveTourBtn">저장</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 팀/선수 -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0;font-size:16px">팀 / 선수</h3>
      <div class="searchbar">
        <input id="searchText" placeholder="팀명/대표자/연락처 검색" class="w-140">
        <button class="btn" id="searchBtn">검색</button>
      </div>
    </div>

    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>팀ID</th>
            <th>대회</th>
            <th>지역</th>
            <th>팀명 / 대표</th>
            <th>종별·디비전</th>
            <th>유니폼</th>
            <th>신청일시</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="teamsTbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- 지도 모달 -->
<div class="modal" id="mapModal">
  <div class="panel">
    <header style="display:flex;align-items:center;justify-content:space-between">
      <div style="font-weight:700">지도에서 위치 선택</div>
      <div class="toolbar">
        <button class="btn" id="closeMapBtn">닫기</button>
      </div>
    </header>
    <main>
      <div class="grid grid-3" style="margin-bottom:8px">
        <input id="mapSearchText" placeholder="주소/장소명으로 검색 (예: 서울대 체육관)">
        <button class="btn" id="mapSearchBtn">검색</button>
        <div class="chips"><span class="chip" id="mapPicked" style="cursor:default">위치 미선택</span></div>
      </div>
      <div id="map"></div>
      <div class="help" style="margin-top:8px">네이버 지도 사용 시 ncpClientId가 필요합니다. 설정값이 없으면 Leaflet(OSM)로 동작합니다.</div>
    </main>
  </div>
</div>

<script>
/* ========= 기본 상수 ========= */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz1qk5MbQvVU3d8Qs3EcPO792iBNlVQR71WhCpNbkqzCcdn5gM17Hqx9AUAIGUwwSKCww/exec';
const APPLY_BASE  = 'https://bdrjoin.netlify.app/';

/* ========= 로컬 저장 ========= */
const store = {
  key: 'BDR_ADMIN_CONF',
  load(){ try { return JSON.parse(localStorage.getItem(this.key) || '{}'); } catch { return {} } },
  save(obj){ localStorage.setItem(this.key, JSON.stringify(obj||{})); }
};
const conf = store.load();
if (!conf.appUrl && WEB_APP_URL) { conf.appUrl = WEB_APP_URL; store.save(conf); }
if (!conf.mapProvider) { conf.mapProvider = 'naver'; store.save(conf); } // 한국 기본: naver

/* ========= DOM helpers ========= */
const $ = s => document.querySelector(s);
const el = html => { const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstElementChild; };

/* ========= 설정(프롬프트 체인) ========= */
$('#settingsBtn').addEventListener('click', ()=>{
  const curUrl = (conf.appUrl || '').trim();
  const valUrl = prompt('Apps Script Web App URL을 입력하세요:', curUrl);
  if (valUrl === null) return;
  conf.appUrl = valUrl.trim();

  const provider = prompt('지도 제공자를 입력하세요 (naver/leaflet). 기본: naver', (conf.mapProvider||'naver'));
  if (provider !== null){
    conf.mapProvider = (provider||'naver').trim().toLowerCase();
  }
  if (conf.mapProvider === 'naver'){
    const cid = prompt('네이버 지도 ncpClientId (없으면 빈칸, 그 경우 Leaflet로 동작):', conf.naverClientId||'');
    if (cid !== null) conf.naverClientId = cid.trim();
  }
  store.save(conf);
  alert('설정이 저장되었습니다. 새로고침합니다.');
  location.reload();
});

/* ========= API ========= */
function requireAppUrl(){
  const appUrl = (conf.appUrl || '').trim();
  if (!appUrl) throw new Error('Web App URL이 설정되지 않았습니다. 우상단 ⚙️를 클릭해 설정하세요.');
  return appUrl;
}
function apiUrl(path, q={}){
  const base = requireAppUrl();
  let u; try { u = new URL(base); } catch(e){ throw new Error('Web App URL이 올바르지 않습니다: ' + base); }
  u.searchParams.set('path', path);
  Object.entries(q).forEach(([k,v])=> u.searchParams.set(k, v));
  return u.toString();
}
async function getJSON(u){
  const r = await fetch(u);
  if (!r.ok) throw new Error('요청 실패: HTTP ' + r.status);
  return r.json();
}
async function postJSON(path, payload){
  const r = await fetch(apiUrl(path), {
    method:'POST',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body: JSON.stringify(payload||{})
  });
  if (!r.ok) throw new Error('요청 실패: HTTP ' + r.status);
  return r.json();
}

/* ========= 헬스 ========= */
async function health(){
  try{
    const j = await getJSON(apiUrl('health'));
    $('#healthDot').style.color = j.ok ? '#22c55e' : '#ef4444';
  }catch{
    $('#healthDot').style.color = '#ef4444';
  }
}

/* ========= 대회 데이터 ========= */
let TOURS = {};
let TOUR_ARRAY = [];
function fmtDate(v){
  if (!v) return '';
  const d = new Date(v);
  if (isNaN(d.getTime())) return String(v);
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const mi = String(d.getMinutes()).padStart(2,'0');
  return `${d.getFullYear()}-${mm}-${dd} ${hh}:${mi}`;
}
function calcStatus(regStart, regEnd){
  if (!regStart || !regEnd) return '상태미정';
  const now = new Date();
  const s = new Date(regStart);
  const e = new Date(regEnd);
  if (isNaN(s.getTime()) || isNaN(e.getTime())) return '상태미정';
  if (now < s) return '접수전';
  if (now > e) return '마감';
  return '접수중';
}
function statusBadgeHtml(status){
  const map = {
    '접수중': {bg:'#ecfdf5', bd:'#d1fae5', fg:'#16a34a'},
    '접수전': {bg:'#eff6ff', bd:'#dbeafe', fg:'#1769ff'},
    '마감':   {bg:'#fef2f2', bd:'#fee2e2', fg:'#ef4444'},
    '상태미정': {bg:'#f1f5fb', bd:'#e4ecf7', fg:'#334155'}
  };
  const c = map[status] || map['상태미정'];
  return `<span class="badge" style="background:${c.bg};border-color:${c.bd};color:${c.fg}">${status}</span>`;
}
async function loadTournaments(){
  const j = await getJSON(apiUrl('tournaments'));
  TOURS = {}; TOUR_ARRAY = j.rows || [];
  TOUR_ARRAY.forEach(t => TOURS[t.TourID] = t);
  renderTournamentList();
  renderTourFilter();
}
function renderTourFilter(){
  const sel = $('#tourFilter');
  const cur = sel.value;
  sel.innerHTML = '<option value="">전체 대회</option>';
  TOUR_ARRAY.forEach(t=>{
    const o = document.createElement('option');
    o.value = t.TourID; o.textContent = t.name;
    sel.appendChild(o);
  });
  if (TOUR_ARRAY.find(x=>x.TourID===cur)) sel.value = cur;
}
function tourCard(t){
  const range = (t.start||t.end) ? `${fmtDate(t.start)} ~ ${fmtDate(t.end)}` : '일정미정';
  const stat = calcStatus(t.regStart, t.regEnd);
  return `<div class="pill" data-id="${t.TourID}"><b>${t.name}</b> · ${stat} · ${range}</div>`;
}
function renderTournamentList(){
  const box = $('#tourList');
  box.innerHTML = (TOUR_ARRAY||[]).map(t=>tourCard(t)).join('');
  box.querySelectorAll('.pill').forEach(el=>{
    el.addEventListener('click', ()=>{
      const t = TOURS[el.dataset.id];
      loadTourToForm(t);
    });
  });
}

/* ========= 팀 표 ========= */
function jerseySVG(hex, label){
  const color = (/^#[0-9a-f]{6}$/i).test(hex||'') ? hex : '#e5e7eb';
  const text = (label||'').toUpperCase();
  return `
  <svg width="42" height="52" viewBox="0 0 42 52" xmlns="http://www.w3.org/2000/svg">
    <g filter="url(#s)">
      <path d="M14 3 l4 6 h6 l4-6 h6 v15 l3 3 v27 a3 3 0 0 1 -3 3 h-26 a3 3 0 0 1 -3 -3 v-27 l3-3 v-15 z"
            fill="${color}" stroke="#cbd5e1" />
      <text x="21" y="31" font-family="system-ui, sans-serif" font-size="9" fill="#0f172a" text-anchor="middle" font-weight="700">${text}</text>
    </g>
    <defs>
      <filter id="s" x="0" y="0" width="42" height="52">
        <feDropShadow dx="0" dy="1" stdDeviation="1" flood-color="#000" flood-opacity=".08"/>
      </filter>
    </defs>
  </svg>`;
}
function normalizeTeamRow(r){
  const region = [r.시도 || r.province || '', r.시군구 || r.city || ''].join(' ').trim();
  const cat    = r.종별 || r.category || '';
  const div    = r.디비전 || r.division || '';
  function pickHex(primary, fallback){
    if (typeof primary === 'string' && /^#[0-9a-f]{6}$/i.test(primary)) return primary.toLowerCase();
    if (typeof fallback === 'string'){
      const m = fallback.match(/#([0-9a-f]{6})/i);
      if (m) return ('#' + m[1]).toLowerCase();
    }
    return '';
  }
  const homeHex = pickHex(r.uniformHomeHex, r['유니폼(홈)']);
  const awayHex = pickHex(r.uniformAwayHex, r['유니폼(어웨이)']);
  return {
    teamId:       r.TeamID || r.teamId || '',
    tourId:       (r.TourID || r.tourId || '').toString().trim(),
    tourName:     r.tourName || r.TourName || r['대회명'] || '',
    region,
    teamName:     r.팀명 || r.teamName || '',
    managerName:  r.대표자이름 || r.managerName || '',
    managerPhone: r.대표자연락처 || r.managerPhone || '',
    category:     cat,
    division:     div,
    homeHex,
    awayHex,
    createdAt:    r.신청일시 || r.createdAt || '',
    editCode:     r.수정코드 || r.editCode || ''
  };
}
function rowTeam(v){
  return `
    <tr>
      <td>${v.teamId}</td>
      <td>${v.tourName || '-'}</td>
      <td>${v.region || '-'}</td>
      <td>
        <div><b>${v.teamName || ''}</b></div>
        <div class="muted">${v.managerName || ''} · ${v.managerPhone || ''}</div>
      </td>
      <td>${v.category || ''} · ${v.division || ''}</td>
      <td><div class="jersey">${jerseySVG(v.homeHex,'HOME')}${jerseySVG(v.awayHex,'AWAY')}</div></td>
      <td>${fmtDate(v.createdAt)}</td>
      <td class="right"><a class="btn" href="${editUrlFor(v.teamId, v.editCode)}" target="_blank" rel="noopener">수정 열기</a></td>
    </tr>`;
}
function editUrlFor(teamId, editCode) {
  const base = APPLY_BASE.replace(/index\.html$/,'');
  const sep = base.endsWith('/') ? '' : '/';
  return `${base}${sep}?edit=${encodeURIComponent(teamId)}&code=${encodeURIComponent(editCode||'')}`;
}
async function loadTeams(){
  try{
    const tourId = ($('#tourFilter').value||'').trim();
    const j = await getJSON(apiUrl('teams', tourId ? { tourId } : {}));
    let rows = Array.isArray(j.rows) ? j.rows : [];
    if (tourId) rows = rows.filter(r => String(r.TourID||r.tourId||'').trim() === tourId);
    const q = ($('#searchText').value||'').trim().toLowerCase();
    if (q){
      rows = rows.filter(r=>{
        const v = normalizeTeamRow(r);
        const blob = [
          v.teamId, v.tourName, v.region, v.teamName,
          v.managerName, v.managerPhone, v.category, v.division
        ].join(' ').toLowerCase();
        return blob.includes(q);
      });
    }
    const html = rows.map(r => rowTeam(normalizeTeamRow(r))).join('');
    $('#teamsTbody').innerHTML = html || `<tr><td colspan="8" class="muted">데이터 없음</td></tr>`;
  }catch(e){
    $('#teamsTbody').innerHTML = `<tr><td colspan="8" class="muted">불러오기 오류: ${e.message}</td></tr>`;
  }
}

/* ========= 종별(구분/종별) 빌더 ========= */
const DIVISION_PRESETS = {
  '일반부': ['D3','D4','D5','D6','D7'],
  '대학부': ['U1','U2','U3','UW'],
  '여성부': ['D3','D4','D5'],
  '유소년부': ['하모니','i1','i2','i3','i4']
};
function makeDivSetRow(init={ group:'일반부', divisions:[] }){
  const row = el(`<div class="place-item"></div>`);

  // 구분
  const groupWrap = el(`<div><label style="margin:0 0 6px">구분</label></div>`);
  const groupSel = el(`<select class="groupSel">${Object.keys(DIVISION_PRESETS).map(g=>`<option value="${g}">${g}</option>`).join('')}</select>`);
  groupWrap.appendChild(groupSel);

  // 종별(복수선택)
  const divWrap = el(`<div><label style="margin:0 0 6px">종별(복수 선택 가능)</label></div>`);
  const divSel = el(`<select class="divSel" multiple size="6" style="height:132px"></select>`);
  divWrap.appendChild(divSel);

  // 빠른 추가(단일 드롭다운)
  const quickWrap = el(`<div><label style="margin:0 0 6px">빠른 추가(드롭다운)</label></div>`);
  const quickBox = el(`<div style="display:flex;gap:8px;align-items:center"></div>`);
  const quickSel = el(`<select class="divQuickSel"></select>`);
  const quickBtn = el(`<button class="btn">추가</button>`);
  quickBox.appendChild(quickSel);
  quickBox.appendChild(quickBtn);
  quickWrap.appendChild(quickBox);

  // 선택 결과 칩
  const tags = el(`<div><label style="margin:0 0 6px">선택 결과</label><div class="chips"></div></div>`);
  const chipsBox = tags.querySelector('.chips');

  // 삭제 버튼
  const del = el(`<div style="display:flex;align-items:flex-end;gap:8px;justify-content:flex-end">
    <button class="btn danger">삭제</button>
  </div>`);
  del.querySelector('button').addEventListener('click', ()=> row.remove());

  // 옵션 렌더링
  function renderDivOptions(group){
    const opts = DIVISION_PRESETS[group];
    divSel.innerHTML   = opts.map(d=>`<option value="${d}">${d}</option>`).join('');
    quickSel.innerHTML = opts.map(d=>`<option value="${d}">${d}</option>`).join('');
  }
  function refreshChips(){
    const vals = [...divSel.selectedOptions].map(o=>o.value);
    chipsBox.innerHTML = vals.length
      ? vals.map(v=>`<span class="chip" data-v="${v}" title="클릭하여 해제">${v} ×</span>`).join('')
      : '<span class="muted" style="padding:6px 0">미선택</span>';
    chipsBox.querySelectorAll('.chip').forEach(c=>{
      c.addEventListener('click', ()=>{
        const v = c.getAttribute('data-v');
        [...divSel.options].forEach(o=>{ if (o.value===v) o.selected=false; });
        refreshChips();
      });
    });
  }
  function addQuick(){
    const v = quickSel.value;
    const opt = [...divSel.options].find(o=>o.value===v);
    if (opt){ opt.selected = true; refreshChips(); }
  }

  groupSel.addEventListener('change', ()=>{ renderDivOptions(groupSel.value); refreshChips(); });
  quickBtn.addEventListener('click', addQuick);
  divSel.addEventListener('change', refreshChips);

  // 초기값
  groupSel.value = init.group || '일반부';
  renderDivOptions(groupSel.value);
  (init.divisions||[]).forEach(v=>{
    const opt = [...divSel.options].find(o=>o.value===v);
    if (opt) opt.selected = true;
  });
  refreshChips();

  // 조립
  row.appendChild(groupWrap);
  row.appendChild(divWrap);
  row.appendChild(quickWrap);
  row.appendChild(tags);
  row.appendChild(del);

  row.getValue = ()=>({ group: groupSel.value, divisions: [...divSel.selectedOptions].map(o=>o.value) });
  return row;
}
function getDivSets(){
  return [...document.querySelectorAll('#divSetList .place-item')].map(it => it.getValue());
}
function setDivSets(list){
  const box = $('#divSetList'); box.innerHTML = '';
  (list && list.length ? list : [{group:'일반부', divisions:[]}]).forEach(v=>{
    box.appendChild(makeDivSetRow(v));
  });
}
$('#addDivSetBtn').addEventListener('click', ()=> $('#divSetList').appendChild(makeDivSetRow()) );

/* ========= 장소(지도) ========= */
let leafMap, leafMarker;
let navMap, navMarker;
let mapResolve = null;

function openMapPicker(prev){
  $('#mapModal').style.display = 'flex';
  setTimeout(()=>initMap(prev), 0);
  return new Promise(res=> mapResolve = res);
}
function closeMapPicker(){ $('#mapModal').style.display = 'none'; mapResolve = null; }

$('#closeMapBtn').addEventListener('click', ()=>{
  if (mapResolve){
    const p = getPickedLatLng();
    mapResolve(p);
  }
  closeMapPicker();
});
document.getElementById('mapModal').addEventListener('click', (e)=>{
  if (e.target.id === 'mapModal'){
    if (mapResolve){
      const p = getPickedLatLng();
      mapResolve(p);
    }
    closeMapPicker();
  }
});
document.addEventListener('keydown', (e)=>{
  if (e.key==='Escape' && $('#mapModal').style.display==='flex'){
    if (mapResolve){ mapResolve(getPickedLatLng()); }
    closeMapPicker();
  }
});

function setPickedText(lat, lng){
  $('#mapPicked').textContent = (lat && lng) ? `선택됨: ${lat.toFixed(6)}, ${lng.toFixed(6)}` : '위치 미선택';
}

function getPickedLatLng(){
  if (conf.mapProvider==='naver' && conf.naverClientId && navMarker){
    const ll = navMarker.getPosition();
    return {lat: ll.y, lng: ll.x};
  }
  if (leafMarker){
    const ll = leafMarker.getLatLng();
    return {lat: ll.lat, lng: ll.lng};
  }
  return null;
}

async function loadNaverScript(){
  if (window.naver && window.naver.maps) return true;
  if (!conf.naverClientId) return false;
  await new Promise((resolve, reject)=>{
    const s = document.createElement('script');
    s.src = 'https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=' + encodeURIComponent(conf.naverClientId);
    s.onload = ()=> resolve();
    s.onerror = ()=> reject(new Error('네이버 지도 스크립트 로드 실패'));
    document.head.appendChild(s);
  });
  return true;
}

async function initMap(prev){
  const useNaver = (conf.mapProvider==='naver' && conf.naverClientId);
  if (useNaver){
    try{
      await loadNaverScript();
      initNaver(prev);
      return;
    }catch(e){
      console.warn('네이버 지도 로드 실패, Leaflet로 폴백:', e);
      initLeaflet(prev);
    }
  }else{
    initLeaflet(prev);
  }
}

function initLeaflet(prev){
  // 해제
  if (leafMap){ leafMap.remove(); leafMap = null; }
  leafMap = L.map('map').setView([37.5665, 126.9780], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(leafMap);
  leafMap.on('click', e=>{
    if (leafMarker){ leafMap.removeLayer(leafMarker); }
    leafMarker = L.marker(e.latlng).addTo(leafMap);
    setPickedText(e.latlng.lat, e.latlng.lng);
  });
  if (prev && prev.lat && prev.lng){
    const ll = [prev.lat, prev.lng];
    leafMap.setView(ll, 15);
    leafMarker = L.marker(ll).addTo(leafMap);
    setPickedText(prev.lat, prev.lng);
  }else{
    setPickedText(null, null);
  }
}

function initNaver(prev){
  // 해제
  navMap = null; navMarker = null;
  const center = (prev && prev.lat && prev.lng)
    ? new naver.maps.LatLng(prev.lat, prev.lng)
    : new naver.maps.LatLng(37.5665, 126.9780);
  navMap = new naver.maps.Map('map', { center, zoom: 13 });
  naver.maps.Event.addListener(navMap, 'click', (e)=>{
    const ll = e.coord;
    if (navMarker) navMarker.setMap(null);
    navMarker = new naver.maps.Marker({ position: ll, map: navMap });
    setPickedText(ll.y, ll.x);
  });
  if (prev && prev.lat && prev.lng){
    navMarker = new naver.maps.Marker({ position: center, map: navMap });
    navMap.setZoom(15);
    setPickedText(prev.lat, prev.lng);
  }else{
    setPickedText(null, null);
  }
}

async function searchAddress(q){
  if (!q) return;
  const useNaver = (conf.mapProvider==='naver' && conf.naverClientId && window.naver && window.naver.maps && naver.maps.Service);
  try{
    if (useNaver){
      naver.maps.Service.geocode({ query: q }, (status, res)=>{
        if (status !== naver.maps.Service.Status.OK || !res?.v2?.addresses?.length){
          alert('검색 결과가 없습니다.');
          return;
        }
        const a = res.v2.addresses[0];
        const lat = parseFloat(a.y), lng = parseFloat(a.x);
        const ll = new naver.maps.LatLng(lat, lng);
        navMap.setCenter(ll); navMap.setZoom(16);
        if (navMarker) navMarker.setMap(null);
        navMarker = new naver.maps.Marker({ position: ll, map: navMap });
        setPickedText(lat, lng);
      });
    }else{
      // Leaflet + Nominatim
      const url = new URL('https://nominatim.openstreetmap.org/search');
      url.searchParams.set('q', q);
      url.searchParams.set('format', 'json');
      url.searchParams.set('addressdetails', '1');
      url.searchParams.set('limit', '1');
      const r = await fetch(url.toString(), { headers:{'Accept-Language':'ko'} });
      const arr = await r.json();
      if (arr && arr[0]){
        const lat = parseFloat(arr[0].lat), lon = parseFloat(arr[0].lon);
        leafMap.setView([lat, lon], 16);
        if (leafMarker) leafMap.removeLayer(leafMarker);
        leafMarker = L.marker([lat, lon]).addTo(leafMap);
        setPickedText(lat, lon);
      }else{
        alert('검색 결과가 없습니다.');
      }
    }
  }catch(e){
    alert('검색 오류: ' + e.message);
  }
}
$('#mapSearchBtn').addEventListener('click', ()=> searchAddress($('#mapSearchText').value.trim()) );

/* 장소 행 */
function makePlaceRow(init={ name:'', address:'', lat:'', lng:'' }){
  const row = el(`<div class="place-item"></div>`);
  const name = el(`<div><label style="margin:0 0 6px">장소명</label><input placeholder="예: 서울대학교 종합체육관" value="${init.name||''}"></div>`);
  const addr = el(`<div><label style="margin:0 0 6px">주소(설명)</label><input placeholder="예: 관악구 대학동 ○○번지" value="${init.address||''}"></div>`);
  const lat  = el(`<div><label style="margin:0 0 6px">위도</label><input placeholder="37.xxxxxx" value="${init.lat||''}"></div>`);
  const lng  = el(`<div><label style="margin:0 0 6px">경도</label><input placeholder="126.xxxxxx" value="${init.lng||''}"></div>`);
  const ctrl = el(`<div style="display:flex;gap:6px;align-items:flex-end">
    <button class="btn" data-map>지도</button>
    <button class="btn danger" data-del>삭제</button>
  </div>`);
  ctrl.querySelector('[data-map]').addEventListener('click', async ()=>{
    const prev = {
      lat: parseFloat(lat.querySelector('input').value),
      lng: parseFloat(lng.querySelector('input').value)
    };
    const picked = await openMapPicker(prev);
    if (picked && picked.lat && picked.lng){
      lat.querySelector('input').value = picked.lat.toFixed(6);
      lng.querySelector('input').value = picked.lng.toFixed(6);
    }
    closeMapPicker();
  });
  ctrl.querySelector('[data-del]').addEventListener('click', ()=> row.remove());

  row.appendChild(name); row.appendChild(addr); row.appendChild(lat); row.appendChild(lng); row.appendChild(ctrl);
  row.getValue = ()=>({
    name: name.querySelector('input').value.trim(),
    address: addr.querySelector('input').value.trim(),
    lat: parseFloat(lat.querySelector('input').value),
    lng: parseFloat(lng.querySelector('input').value)
  });
  return row;
}
function getPlaces(){ return [...document.querySelectorAll('#placeList .place-item')].map(it => it.getValue()); }
function setPlaces(list){ const box=$('#placeList'); box.innerHTML=''; (list&&list.length?list:[{}]).forEach(v=> box.appendChild(makePlaceRow(v))); }
$('#addPlaceBtn').addEventListener('click', ()=> $('#placeList').appendChild(makePlaceRow()) );

/* ========= 폼 로드/초기화 ========= */
function toLocalDT(d){
  const pad=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function updateStatusBadge(){
  const s = $('#regStart').value || '';
  const e = $('#regEnd').value || '';
  const st = calcStatus(s, e);
  $('#tourStatusBadge').innerHTML = statusBadgeHtml(st);
}
['regStart','regEnd'].forEach(id=> $('#'+id).addEventListener('change', updateStatusBadge));

function loadTourToForm(t){
  $('#tourFormTitle').textContent = '대회 수정';
  $('#tourId').value = t.TourID || '';
  $('#tourName').value = t.name || '';
  $('#tourUrl').value = t.url || '';
  $('#tourStart').valueAsDate = t.start ? new Date(t.start) : null;
  $('#tourEnd').valueAsDate   = t.end ? new Date(t.end) : null;

  // 접수기간(datetime-local)
  const regS = t.regStart ? new Date(t.regStart) : null;
  const regE = t.regEnd   ? new Date(t.regEnd)   : null;
  $('#regStart').value = regS ? toLocalDT(regS) : '';
  $('#regEnd').value   = regE ? toLocalDT(regE) : '';
  updateStatusBadge();

  // 종별 세트 (신규 필드 우선, 없으면 기존 divs 변환)
  let divSets = t.divSets;
  if (!Array.isArray(divSets) || !divSets.length){
    const m = t.divs || {};
    divSets = Object.keys(m).map(g=>({ group:g, divisions: m[g]||[] }));
  }
  setDivSets(divSets);

  // 장소
  setPlaces(Array.isArray(t.places)? t.places : []);
}
function clearTourForm(){
  $('#tourFormTitle').textContent = '대회 등록';
  ['tourId','tourName','tourUrl','tourStart','tourEnd','regStart','regEnd'].forEach(id=> $('#'+id).value = '');
  setDivSets([{group:'일반부', divisions:[]}]);
  setPlaces([{}]);
  updateStatusBadge();
}

/* ========= 저장/삭제 ========= */
$('#newTourBtn').addEventListener('click', clearTourForm);

$('#saveTourBtn').addEventListener('click', async ()=>{
  try{
    const name = ($('#tourName').value||'').trim();
    if (!name) return alert('대회명을 입력하세요.');

    // 종별 세트
    const divSets = getDivSets().map(s=>({ group:s.group, divisions:(s.divisions||[]) }));
    const divs = {};
    divSets.forEach(s=>{
      if (!divs[s.group]) divs[s.group] = [];
      (s.divisions||[]).forEach(d=>{ if (!divs[s.group].includes(d)) divs[s.group].push(d); });
    });

    // 장소
    const places = getPlaces().filter(p=> p.name || p.address || (p.lat && p.lng));

    const regStart = $('#regStart').value || '';
    const regEnd   = $('#regEnd').value   || '';
    const status   = calcStatus(regStart, regEnd); // 자동 계산

    const payload = {
      tourId: ($('#tourId').value || '').trim(),
      name,
      start: $('#tourStart').value || '',
      end: $('#tourEnd').value || '',
      regStart, regEnd,
      status,          // ← 자동 계산된 값 전송(표시는 항상 클라이언트에서 재계산)
      url: ($('#tourUrl').value || '').trim(),
      divSets,         // 신규
      divs,            // 레거시 호환
      places           // [{name,address,lat,lng}]
    };

    const j = await postJSON('upsertTournament', payload);
    if (!j.ok) return alert('저장 실패: ' + (j.error||'unknown'));
    await loadTournaments();
    if (j.tourId) $('#tourId').value = j.tourId;
    alert('저장되었습니다.');
  }catch(e){
    alert('저장 중 오류: ' + e.message);
  }
});

$('#deleteTourBtn').addEventListener('click', async ()=>{
  const id = ($('#tourId').value || '').trim();
  if (!id) return alert('삭제할 대회가 선택되지 않았습니다.');
  if (!confirm('정말 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) return;
  try{
    const j = await postJSON('removeTournament', { tourId: id });
    if (!j.ok) return alert('삭제 실패: ' + (j.error||'unknown'));
    clearTourForm();
    await loadTournaments();
    alert('삭제되었습니다.');
  }catch(e){
    alert('삭제 중 오류: ' + e.message);
  }
});

/* ========= 이벤트 ========= */
$('#reloadBtn').addEventListener('click', async ()=>{
  await health();
  await loadTournaments();
  await loadTeams();
});
$('#tourFilter').addEventListener('change', loadTeams);
$('#searchBtn').addEventListener('click', loadTeams);
$('#searchText').addEventListener('keydown', e=>{ if(e.key==='Enter') loadTeams(); });

/* ========= 부트 ========= */
(async function boot(){
  if (!conf.appUrl) {
    alert('처음 사용이라면 ⚙️ 버튼에서 Web App URL을 먼저 설정하세요.');
    return;
  }
  await health();
  await loadTournaments();
  await loadTeams();
  updateStatusBadge();
})();
</script>
</body>
</html>

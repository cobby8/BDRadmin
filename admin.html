<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BDR 관리자</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --blue:#1769ff; --bg:#f6f8fb; --card:#fff; --muted:#6b7684; --red:#ef4444; --green:#16a34a }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:'Pretendard','Apple SD Gothic Neo',sans-serif;color:#222}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px 64px}
  header{display:flex;justify-content:space-between;align-items:center;margin:10px 0 18px}
  h1{font-size:20px;margin:0}
  .card{background:var(--card);border-radius:14px;box-shadow:0 8px 28px rgba(23,105,255,.08);padding:16px;margin-top:16px}
  .row{display:grid;gap:12px}
  @media(min-width:720px){ .row-2{grid-template-columns:1.2fr 2fr} .row-3{grid-template-columns:1fr 1fr 1fr} }
  label{display:block;font-weight:600;margin:10px 0 6px}
  input,select,textarea{width:100%;padding:12px;border:1px solid #e6ecf5;border-radius:12px;font-size:14px;outline:none}
  input:focus,select:focus,textarea:focus{border-color:var(--blue)}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid #dfe6ee;background:#fff;cursor:pointer}
  .btn.primary{background:var(--blue);color:#fff;border-color:var(--blue)}
  .btn.danger{background:#fff;color:var(--red);border-color:#ffd1d1}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted);font-size:12px}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  th{font-size:12px;color:#5b6472;text-align:left;padding:0 10px}
  td{background:#fff;padding:12px 10px;border-top:1px solid #eef2f7;border-bottom:1px solid #eef2f7}
  tr td:first-child{border-left:1px solid #eef2f7;border-radius:12px 0 0 12px}
  tr td:last-child{border-right:1px solid #eef2f7;border-radius:0 12px 12px 0}
  .right{display:flex;gap:8px;justify-content:flex-end}
  .jersey{display:inline-flex;align-items:center;gap:6px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>BDR 관리자</h1>
    <div class="toolbar">
      <span class="muted" id="healthDot">●</span>
      <button class="btn" id="settingsBtn">⚙️ 설정</button>
      <button class="btn" id="reloadBtn">새로고침</button>
    </div>
  </header>

  <!-- 대회 필터 -->
  <div class="card">
    <div class="row row-3">
      <div>
        <label>대회 필터</label>
        <select id="tourFilter"><option value="">전체 대회</option></select>
      </div>
      <div class="muted" style="align-self:end">※ ⚙️에서 Web App URL을 설정/수정할 수 있습니다.</div>
    </div>
  </div>

  <!-- 대회 관리 -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0;font-size:16px">대회 관리</h3>
      <div class="toolbar"><button class="btn" id="newTourBtn">신규 대회</button></div>
    </div>

    <div class="row row-2">
      <div>
        <label>대회 목록</label>
        <div id="tourList"></div>
      </div>

      <div>
        <label id="tourFormTitle">대회 등록/수정</label>
        <div class="row row-3">
          <input id="tourId" placeholder="자동생성(수정 시 고정)" disabled>
          <input id="tourName" placeholder="대회명">
          <input id="tourStatus" placeholder="상태(접수중, 마감 등)">
          <input id="tourStart" type="date" placeholder="시작일">
          <input id="tourEnd" type="date" placeholder="종료일">
          <input id="tourUrl" placeholder="안내 페이지 URL(선택)">
        </div>
        <label style="margin-top:12px">종별/디비전(줄바꿈으로 추가)</label>
        <textarea id="tourDivs" rows="6" placeholder="예)
일반부: D3,D4,D5
여성부: D3,D4
40대부: D3,D4,D5
유소년부: 하모니,i1,i2,i3"></textarea>
        <div class="toolbar" style="margin-top:10px">
          <button class="btn primary" id="saveTourBtn">저장</button>
          <button class="btn danger" id="deleteTourBtn">삭제</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 팀/선수 -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0;font-size:16px">팀 / 선수</h3>
      <div class="toolbar">
        <input id="searchText" placeholder="팀명/대표자/연락처 검색" style="width:180px">
        <button class="btn" id="searchBtn">검색</button>
      </div>
    </div>

    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>팀ID</th>
            <th>대회</th>
            <th>지역</th>
            <th>팀명 / 대표</th>
            <th>종별·디비전</th>
            <th>유니폼</th>
            <th>신청일시</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="teamsTbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ========= 초기 기본값(최초 자동 세팅) ========= */
const DEFAULT_WEB_APP_URL = 'YOUR_DEPLOYED_WEB_APP_URL_HERE'; // ← 실제 배포 URL로 교체!
const APPLY_BASE  = 'https://bdrjoin.netlify.app/'; // 신청서 실제 배포 루트

/* ========= 로컬 저장 ========= */
const store = { key:'BDR_ADMIN_CONF', load(){ try{ return JSON.parse(localStorage.getItem(this.key)||'{}'); }catch{ return {} } }, save(o){ localStorage.setItem(this.key, JSON.stringify(o||{})); } };
const conf = store.load();
if (!conf.appUrl && DEFAULT_WEB_APP_URL){ conf.appUrl = DEFAULT_WEB_APP_URL; store.save(conf); }

/* ========= DOM ========= */
const $ = s => document.querySelector(s);

/* ========= 설정 다이얼 ========= */
function requireAppUrl(){
  const appUrl=(conf.appUrl||'').trim();
  if (!appUrl) throw new Error('Web App URL이 필요합니다. 우상단 ⚙️에서 설정해 주세요.');
  return appUrl;
}
$('#settingsBtn').addEventListener('click', ()=>{
  const cur=(conf.appUrl||'').trim();
  const val=prompt('Apps Script Web App URL을 입력하세요:', cur);
  if (val===null) return;
  conf.appUrl = (val||'').trim();
  store.save(conf);
  alert('저장되었습니다. 새로고침합니다.');
  location.reload();
});

/* ========= API ========= */
function apiUrl(path, q={}){
  const base=requireAppUrl();
  const u=new URL(base);
  u.searchParams.set('path', path);
  Object.entries(q).forEach(([k,v])=> u.searchParams.set(k, v));
  return u.toString();
}
async function getJSON(u){ const r=await fetch(u); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
async function postJSON(path, payload){
  const r=await fetch(apiUrl(path), { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(payload||{}) });
  if(!r.ok) throw new Error('HTTP '+r.status);
  return r.json();
}

/* ========= 헬스 ========= */
async function health(){
  try{ const j=await getJSON(apiUrl('health')); $('#healthDot').style.color = j.ok? '#22c55e':'#ef4444'; }
  catch{ $('#healthDot').style.color = '#ef4444'; }
}

/* ========= 대회 관리 ========= */
let TOURS={}, TOUR_ARRAY=[];

function divsToText(divs){ if(!divs) return ''; return Object.keys(divs).map(k=> `${k}: ${(divs[k]||[]).join(',')}`).join('\n'); }
function textToDivs(text){
  const out={};
  (text||'').replace(/\r\n/g,'\n').split('\n').map(s=>s.trim()).filter(Boolean).forEach(line=>{
    const [cat, rest] = line.split(':'); const k=(cat||'').trim(); const v=(rest||'').trim(); if(!k||!v) return;
    out[k] = v.split(',').map(s=>s.trim()).filter(Boolean);
  });
  return out;
}
async function loadTournaments(){
  const j=await getJSON(apiUrl('tournaments')); TOURS={}; TOUR_ARRAY=j.rows||[]; TOUR_ARRAY.forEach(t=> TOURS[t.TourID]=t);
  renderTournamentList(); renderTourFilter();
}
function renderTourFilter(){
  const sel=$('#tourFilter'); const cur=sel.value;
  sel.innerHTML='<option value="">전체 대회</option>';
  TOUR_ARRAY.forEach(t=>{ const o=document.createElement('option'); o.value=t.TourID; o.textContent=t.name; sel.appendChild(o); });
  if (TOUR_ARRAY.find(x=>x.TourID===cur)) sel.value=cur;
}
function renderTournamentList(){
  const box=$('#tourList'); box.innerHTML='';
  (TOUR_ARRAY||[]).forEach(t=>{
    const div=document.createElement('div'); div.className='muted'; div.style.margin='6px 0';
    const range=(t.start||t.end)? `${fmtDate(t.start)} ~ ${fmtDate(t.end)}`:'일정미정';
    div.innerHTML=`<span class="btn" data-id="${t.TourID}" style="padding:6px 10px">${t.name}</span> <span class="muted">${t.status||''} · ${range}</span>`;
    div.querySelector('span.btn').addEventListener('click', ()=> loadTourToForm(t));
    box.appendChild(div);
  });
}
function loadTourToForm(t){
  $('#tourFormTitle').textContent='대회 수정';
  $('#tourId').value=t.TourID||'';
  $('#tourName').value=t.name||'';
  $('#tourStatus').value=t.status||'';
  $('#tourStart').valueAsDate = t.start ? new Date(t.start) : null;
  $('#tourEnd').valueAsDate   = t.end ? new Date(t.end) : null;
  $('#tourUrl').value=t.url||'';
  $('#tourDivs').value=divsToText(t.divs||{});
}
function clearTourForm(){ $('#tourFormTitle').textContent='대회 등록'; ['tourId','tourName','tourStatus','tourStart','tourEnd','tourUrl','tourDivs'].forEach(id=> $('#'+id).value=''); }
$('#newTourBtn').addEventListener('click', clearTourForm);
$('#saveTourBtn').addEventListener('click', async ()=>{
  try{
    const payload={ tourId:($('#tourId').value||'').trim(), name:($('#tourName').value||'').trim(), status:($('#tourStatus').value||'').trim(), start:$('#tourStart').value||'', end:$('#tourEnd').value||'', url:$('#tourUrl').value||'', divs:textToDivs($('#tourDivs').value) };
    if (!payload.name) return alert('대회명을 입력하세요.');
    const j=await postJSON('saveTournament', payload);
    if(!j.ok) return alert('저장 실패: '+(j.error||'unknown'));
    await loadTournaments(); if (j.tourId) $('#tourId').value = j.tourId; alert('저장되었습니다.');
  }catch(e){ alert('저장 오류: '+e.message); }
});
$('#deleteTourBtn').addEventListener('click', async ()=>{
  const id=($('#tourId').value||'').trim(); if(!id) return alert('삭제할 대회를 선택하세요.');
  if(!confirm('정말 삭제하시겠습니까?')) return;
  try{ const j=await postJSON('deleteTournament', { tourId:id }); if(!j.ok) return alert('삭제 실패: '+(j.error||'unknown')); clearTourForm(); await loadTournaments(); alert('삭제되었습니다.'); }
  catch(e){ alert('삭제 오류: '+e.message); }
});

/* ========= 팀 목록 ========= */
function fmtDate(v){ if(!v) return ''; const d=new Date(v); if(isNaN(d.getTime())) return String(v); const mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'), hh=String(d.getHours()).padStart(2,'0'), mi=String(d.getMinutes()).padStart(2,'0'); return `${d.getFullYear()}-${mm}-${dd} ${hh}:${mi}`; }
function jerseySVG(hex, label){
  const color = (/^#[0-9A-Fa-f]{6}$/).test(hex||'') ? hex : '#e5e7eb';
  const text = (label||'').toUpperCase();
  return `
  <svg width="42" height="52" viewBox="0 0 42 52" xmlns="http://www.w3.org/2000/svg">
    <g filter="url(#s)">
      <path d="M14 3 l4 6 h6 l4-6 h6 v15 l3 3 v27 a3 3 0 0 1 -3 3 h-26 a3 3 0 0 1 -3 -3 v-27 l3-3 v-15 z"
            fill="${color}" stroke="#cbd5e1" />
      <text x="21" y="31" font-family="system-ui, sans-serif" font-size="9" fill="#0f172a" text-anchor="middle" font-weight="700">${text}</text>
    </g>
    <defs>
      <filter id="s" x="0" y="0" width="42" height="52">
        <feDropShadow dx="0" dy="1" stdDeviation="1" flood-color="#000" flood-opacity=".08"/>
      </filter>
    </defs>
  </svg>`;
}
function editUrlFor(teamId, editCode) {
  const base = APPLY_BASE.replace(/index\.html$/,'');
  const sep = base.endsWith('/') ? '' : '/';
  return `${base}${sep}?edit=${encodeURIComponent(teamId)}&code=${encodeURIComponent(editCode||'')}`;
}
function rowTeam(r){
  const home = r.uniformHomeHex || r['유니폼(홈)'] || '';
  const away = r.uniformAwayHex || r['유니폼(어웨이)'] || '';
  const editHref = editUrlFor(r.TeamID, r.수정코드);
  const joinHref = r.joinUrl || '';
  return `
    <tr>
      <td>${r.TeamID}</td>
      <td>${r.TourName||r.tourName||''}</td>
      <td>${r.시도||''} ${r.시군구||''}</td>
      <td>
        <div><b>${r.팀명||''}</b></div>
        <div class="muted">${r.대표자이름||''} · ${r.대표자연락처||''}</div>
      </td>
      <td>${r.종별||''} · ${r.디비전||''}</td>
      <td><div class="jersey">${jerseySVG(home,'HOME')}${jerseySVG(away,'AWAY')}</div></td>
      <td>${fmtDate(r.신청일시)}</td>
      <td class="right">
        <a class="btn" href="${editHref}" target="_blank" rel="noopener">수정 열기</a>
        <button class="btn" data-join="${joinHref}">셀프등록 링크 복사</button>
      </td>
    </tr>`;
}

async function loadTeams(){
  try{
    const tourId = ($('#tourFilter').value||'').trim();
    const j = await getJSON(apiUrl('teams', tourId ? { tourId } : {}));
    let rows = j.rows || [];
    // 서버 필터 2차 보정
    if (tourId) rows = rows.filter(x => String(x.TourID||'') === String(tourId));

    const q = ($('#searchText').value||'').trim().toLowerCase();
    if (q) rows = rows.filter(r=>{
      const blob = [r.TeamID,r.팀명,r.대표자이름,r.대표자연락처,r.시도,r.시군구,(r.TourName||r.tourName||''),(r.종별||''),(r.디비전||'')].join(' ').toLowerCase();
      return blob.includes(q);
    });

    const html = rows.map(r=>rowTeam(r)).join('');
    $('#teamsTbody').innerHTML = html || `<tr><td colspan="8" class="muted">데이터 없음</td></tr>`;

    // 복사 핸들러 바인딩
    $('#teamsTbody').querySelectorAll('button[data-join]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const url = btn.getAttribute('data-join') || '';
        if (!url) return alert('서버에 JOIN_BASE 설정이 없어 링크를 만들 수 없습니다.');
        try{ await navigator.clipboard.writeText(url); alert('셀프등록 링크를 복사했습니다.'); }
        catch{ alert('복사 실패: 브라우저 권한을 확인하세요.'); }
      });
    });
  }catch(e){
    $('#teamsTbody').innerHTML = `<tr><td colspan="8" class="muted">불러오기 오류: ${e.message}</td></tr>`;
  }
}

/* ========= 이벤트 ========= */
$('#reloadBtn').addEventListener('click', async ()=>{ await health(); await loadTournaments(); await loadTeams(); });
$('#tourFilter').addEventListener('change', loadTeams);
$('#searchBtn').addEventListener('click', loadTeams);
$('#searchText').addEventListener('keydown', e=>{ if(e.key==='Enter') loadTeams(); });

/* ========= 부트 ========= */
(async function boot(){
  if (!conf.appUrl) { alert('⚙️ 버튼을 눌러 Web App URL을 먼저 설정하세요.'); return; }
  await health();
  await loadTournaments();
  await loadTeams();
})();
</script>
</body>
</html>

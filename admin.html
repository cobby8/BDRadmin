<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BDR ê´€ë¦¬ì</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --blue:#1769ff; --bg:#f6f8fb; --card:#fff; --muted:#6b7684; --red:#ef4444; --green:#16a34a }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:'Pretendard','Apple SD Gothic Neo',sans-serif;color:#222}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px 64px}
  header{display:flex;justify-content:space-between;align-items:center;margin:10px 0 18px}
  h1{font-size:20px;margin:0}
  .card{background:var(--card);border-radius:14px;box-shadow:0 8px 28px rgba(23,105,255,.08);padding:16px;margin-top:16px}
  .row{display:grid;gap:12px}
  @media(min-width:720px){ .row-2{grid-template-columns:1.2fr 2fr} .row-3{grid-template-columns:1fr 1fr 1fr} }
  label{display:block;font-weight:600;margin:10px 0 6px}
  input,select,textarea{width:100%;padding:12px;border:1px solid #e6ecf5;border-radius:12px;font-size:14px;outline:none;background:#fff}
  input:focus,select:focus,textarea:focus{border-color:var(--blue)}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid #dfe6ee;background:#fff;cursor:pointer}
  .btn.primary{background:var(--blue);color:#fff;border-color:var(--blue)}
  .btn.danger{background:#fff;color:#ef4444;border-color:#ffd1d1}
  .btn.ghost{background:#fff;color:#334155;border-color:#e6ecf5}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted);font-size:12px}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  th{font-size:12px;color:#5b6472;text-align:left;padding:0 10px}
  td{background:#fff;padding:12px 10px;border-top:1px solid #eef2f7;border-bottom:1px solid #eef2f7}
  tr td:first-child{border-left:1px solid #eef2f7;border-radius:12px 0 0 12px}
  tr td:last-child{border-right:1px solid #eef2f7;border-radius:0 12px 12px 0}
  .badge{display:inline-flex;gap:6px;align-items:center;font-size:12px;color:#334155;background:#f1f5fb;border:1px solid #e4ecf7;border-radius:999px;padding:4px 8px}
  .right{display:flex;justify-content:flex-end}
  .grid{display:grid;gap:10px}
  .grid-2{grid-template-columns:1fr 1fr}
  .help{font-size:12px;color:#6b7280}
  .section-title{font-weight:700;margin:16px 0 6px}
  .subtle{font-size:13px;color:#475569;margin-top:-6px}
  .place-item{display:grid;gap:8px;grid-template-columns:1.2fr 2fr .9fr .9fr auto;align-items:center;border:1px solid #e6ecf5;border-radius:12px;padding:10px;background:#fff}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px solid #e6ecf5;border-radius:999px;padding:6px 10px;font-size:12px;background:#fff;cursor:pointer}
  .list{display:grid;gap:10px}
  .hr{height:1px;background:#eef2f7;margin:8px 0}
  .input-icon{position:relative}
  .eye-btn{position:absolute;right:10px;top:50%;transform:translateY(-50%);border:0;background:transparent;cursor:pointer;font-size:16px}
  .offscreen{position:absolute;left:-9999px;opacity:0;width:0;height:0;pointer-events:none}
  .locked *[data-editable]{pointer-events:none; opacity:.9}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
  .modal .panel{background:#fff;width:min(720px,96vw);max-height:90vh;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.18);display:flex;flex-direction:column}
  .modal .panel header{padding:12px 16px;border-bottom:1px solid #eef2f7}
  .modal .panel main{padding:12px 16px;overflow:auto}
  .dd-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;max-height:220px;overflow:auto;margin:6px 0}
  .dd-actions{display:flex;gap:8px;justify-content:flex-end}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>BDR ê´€ë¦¬ì</h1>
    <div class="toolbar">
      <span class="muted" id="healthDot">â—</span>
      <button class="btn" id="settingsBtn">âš™ï¸ ì„¤ì •</button>
      <button class="btn" id="reloadBtn">ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </header>

  <!-- ìë™ì™„ì„± íŠ¸ë© -->
  <input class="offscreen" type="text" autocomplete="username" />
  <input class="offscreen" type="password" autocomplete="current-password" />

  <!-- ëŒ€íšŒ í•„í„° -->
  <div class="card">
    <div class="row row-3">
      <div>
        <label>ëŒ€íšŒ í•„í„°</label>
        <select id="tourFilter"><option value="">ì „ì²´ ëŒ€íšŒ</option></select>
      </div>
      <div class="muted" style="align-self:end">â€» âš™ï¸ì—ì„œ Apps Script URLì„ í™•ì¸/ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    </div>
  </div>

  <!-- ëŒ€íšŒ ê´€ë¦¬ -->
  <div class="card" id="formCard">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0;font-size:16px">ëŒ€íšŒ ê´€ë¦¬</h3>
      <div class="toolbar">
        <button class="btn" id="newTourBtn">ì‹ ê·œ ëŒ€íšŒ</button>
        <button class="btn" id="editBtn" disabled>ìˆ˜ì •</button>
      </div>
    </div>

    <div class="row row-2">
      <div>
        <label>ëŒ€íšŒ ëª©ë¡</label>
        <div id="tourList" class="grid"></div>
      </div>

      <div id="formArea" class="locked">
        <label id="tourFormTitle">ëŒ€íšŒ ë“±ë¡/ìˆ˜ì •</label>

        <div class="grid">
          <input id="tourId" placeholder="ìë™ìƒì„± (ìˆ˜ì • ì‹œ ê³ ì •)" disabled>
          <input id="tourName" placeholder="ëŒ€íšŒëª…" data-editable>
          <input id="tourUrl" placeholder="ì•ˆë‚´ í˜ì´ì§€ URL (ì„ íƒ)" data-editable inputmode="url" autocomplete="off" spellcheck="false">
        </div>

        <div class="section-title">ì¢…ë³„ ì„¤ì •</div>
        <div class="subtle">í¸ì§‘ ëª¨ë“œì—ì„œë§Œ <b>+ êµ¬ë¶„/ì¢…ë³„ ì¶”ê°€</b>ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì‹ ê·œ ëŒ€íšŒëŠ” ê¸°ë³¸ í–‰ ì—†ì´ ë²„íŠ¼ë§Œ ë³´ì…ë‹ˆë‹¤.</div>
        <div id="divSetList" class="list" style="margin-top:8px"></div>
        <div class="toolbar" style="margin-top:6px;justify-content:flex-end">
          <button class="btn ghost" id="addDivSetBtn" data-editable disabled>+ êµ¬ë¶„/ì¢…ë³„ ì¶”ê°€</button>
        </div>

        <div class="hr"></div>

        <div class="section-title">ëŒ€íšŒì¥ì†Œ</div>
        <div class="subtle">+ ì¥ì†Œ ì¶”ê°€ í´ë¦­ â†’ í–‰ì•ˆë¶€ ì£¼ì†Œê²€ìƒ‰ íŒì—… â†’ ì„ íƒì‹œ ìë™ ì…ë ¥ë©ë‹ˆë‹¤.</div>
        <div id="placeList" class="list" style="margin-top:8px"></div>
        <div class="toolbar" style="margin-top:6px;justify-content:flex-end">
          <button class="btn ghost" id="addPlaceBtn" data-editable disabled>+ ì¥ì†Œ ì¶”ê°€</button>
        </div>

        <div class="hr"></div>

        <div class="section-title">ëŒ€íšŒê¸°ê°„</div>
        <div class="grid grid-2">
          <input id="tourStart" type="date" placeholder="ì‹œì‘ì¼" data-editable>
          <input id="tourEnd" type="date" placeholder="ì¢…ë£Œì¼" data-editable>
        </div>

        <div class="section-title" style="margin-top:14px">ì ‘ìˆ˜ê¸°ê°„</div>
        <div class="grid grid-2">
          <input id="regStart" type="datetime-local" placeholder="ì ‘ìˆ˜ ì‹œì‘" data-editable>
          <input id="regEnd" type="datetime-local" placeholder="ì ‘ìˆ˜ ì¢…ë£Œ" data-editable>
        </div>

        <div class="grid grid-2" style="margin-top:12px;align-items:end">
          <div>
            <label>ëŒ€íšŒê´€ë¦¬ ì½”ë“œ (í•„ìˆ˜)</label>
            <div class="input-icon">
              <input id="adminCode" type="password" placeholder="ì´ ëŒ€íšŒë¥¼ ê´€ë¦¬í•  ë¹„ë°€ë²ˆí˜¸"
                     data-editable autocomplete="new-password" readonly>
              <button class="eye-btn" id="toggleCodeBtn" title="ë³´ê¸°/ìˆ¨ê¸°ê¸°">ğŸ‘ï¸</button>
            </div>
            <div class="help">ì‹ ê·œ ìƒì„± ì‹œ ì„¤ì •, ì´í›„ ìˆ˜ì •/ì‚­ì œ ì‹œ ë™ì¼ ì½”ë“œ í•„ìš”. (í¬ì»¤ìŠ¤ ì‹œì—ë§Œ ì…ë ¥ ê°€ëŠ¥)</div>
            <div style="margin-top:8px">
              <label>ìƒíƒœ(ìë™)</label>
              <div id="tourStatusBadge" class="badge">ìƒíƒœë¯¸ì •</div>
            </div>
          </div>
          <div class="toolbar" style="justify-content:flex-end;gap:8px">
            <button class="btn danger" id="deleteTourBtn" data-editable disabled>ì‚­ì œ</button>
            <button class="btn primary" id="saveTourBtn" data-editable disabled>ì €ì¥</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- íŒ€/ì„ ìˆ˜ -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0;font-size:16px">íŒ€ / ì„ ìˆ˜</h3>
      <div class="searchbar">
        <input id="searchText" placeholder="íŒ€ëª…/ëŒ€í‘œì/ì—°ë½ì²˜ ê²€ìƒ‰" class="w-140">
        <button class="btn" id="searchBtn">ê²€ìƒ‰</button>
      </div>
    </div>

    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>íŒ€ID</th><th>ëŒ€íšŒ</th><th>ì§€ì—­</th><th>íŒ€ëª… / ëŒ€í‘œ</th><th>ì¢…ë³„Â·ë””ë¹„ì „</th><th>ìœ ë‹ˆí¼</th><th>ì‹ ì²­ì¼ì‹œ</th><th></th>
          </tr>
        </thead>
        <tbody id="teamsTbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ì¢…ë³„ ì„ íƒ ëª¨ë‹¬ -->
<div class="modal" id="divModal">
  <div class="panel">
    <header style="display:flex;align-items:center;justify-content:space-between">
      <div style="font-weight:700">êµ¬ë¶„/ì¢…ë³„ ì„ íƒ</div>
      <div class="toolbar"><button class="btn" id="divCloseBtn">ë‹«ê¸°</button></div>
    </header>
    <main>
      <div class="grid grid-3" style="margin-bottom:8px">
        <div>
          <label>êµ¬ë¶„</label>
          <select id="divGroupSel"></select>
        </div>
        <div style="grid-column: span 2">
          <label>ì¢…ë³„(ë³µìˆ˜ ì„ íƒ)</label>
          <div class="dd-row" id="divChecks"></div>
        </div>
      </div>
      <div class="dd-actions">
        <button class="btn" id="divApplyBtn">ì ìš©</button>
      </div>
    </main>
  </div>
</div>

<script>
/* ===== ìƒìˆ˜ ===== */
const WEB_APP_URL='https://script.google.com/macros/s/AKfycbz1qk5MbQvVU3d8Qs3EcPO792iBNlVQR71WhCpNbkqzCcdn5gM17Hqx9AUAIGUwwSKCww/exec';
const APPLY_BASE ='https://bdrjoin.netlify.app/';
const JUSO_KEY   ='U01TX0FVVEgyMDI1MDkwOTIzNTcyMjExNjE2NDQ=';
const JUSO_RETURN= location.origin + '/juso-callback.html';

const store={ key:'BDR_ADMIN_CONF', load(){try{return JSON.parse(localStorage.getItem(this.key)||'{}')}catch{return{}}}, save(o){localStorage.setItem(this.key,JSON.stringify(o||{}))}};
const conf=store.load(); if(!conf.appUrl&&WEB_APP_URL){conf.appUrl=WEB_APP_URL; store.save(conf);}
const $=s=>document.querySelector(s); const el=h=>{const t=document.createElement('template'); t.innerHTML=h.trim(); return t.content.firstElementChild;};

/* ===== í–‰ì•ˆë¶€ ì½œë°± ê°€ë“œ & postMessage ìˆ˜ì‹  ===== */
(function(){const p=new URLSearchParams(location.search); if(p.get('inputYn')==='Y'&&window.opener&&window.opener.__onJusoSelected){const d=Object.fromEntries(p.entries()); window.opener.__onJusoSelected(d); setTimeout(()=>window.close(),0);}})();
window.addEventListener('message',(e)=>{ if(e.data&&e.data.type==='JUSO_SELECTED'&&typeof __onJusoSelected==='function'){ __onJusoSelected(e.data.payload); }});

/* ===== ìœ í‹¸ ===== */
function apiUrl(path,q={}){ const base=(conf.appUrl||'').trim(); if(!base) throw new Error('Web App URL ë¯¸ì„¤ì •'); const u=new URL(base); u.searchParams.set('path',path); Object.entries(q).forEach(([k,v])=>u.searchParams.set(k,v)); return u.toString();}
async function getJSON(u){const r=await fetch(u); if(!r.ok) throw new Error('HTTP '+r.status); return r.json();}
async function postJSON(path,payload){const r=await fetch(apiUrl(path),{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload||{})}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json();}
async function health(){ try{const j=await getJSON(apiUrl('health')); $('#healthDot').style.color=j.ok?'#22c55e':'#ef4444';}catch{$('#healthDot').style.color='#ef4444';}}

function pad(n){return String(n).padStart(2,'0')}
function fmtDate(v){if(!v)return'';const d=new Date(v); if(isNaN(d))return String(v); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;}
function toInputDateOnly(s){if(!s)return''; if(typeof s==='string'){const m=s.match(/^(\d{4}-\d{2}-\d{2})/); if(m)return m[1];} const d=new Date(s); if(!isNaN(d))return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; return '';}
function toInputDT(s){if(!s)return''; if(typeof s==='string'){const m=s.match(/^(\d{4}-\d{2}-\d{2})[ T](\d{2}):(\d{2})/); if(m)return `${m[1]}T${m[2]}:${m[3]}`;} const d=new Date(s); if(!isNaN(d))return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; return '';}
function calcStatus(rs,re){if(!rs||!re)return'ìƒíƒœë¯¸ì •'; const s=new Date(rs), e=new Date(re), n=new Date(); if(isNaN(s)||isNaN(e))return'ìƒíƒœë¯¸ì •'; if(n<s)return'ì ‘ìˆ˜ì „'; if(n>e)return'ë§ˆê°'; return'ì ‘ìˆ˜ì¤‘';}
function statusBadgeHtml(st){const m={'ì ‘ìˆ˜ì¤‘':{bg:'#ecfdf5',bd:'#d1fae5',fg:'#16a34a'},'ì ‘ìˆ˜ì „':{bg:'#eff6ff',bd:'#dbeafe',fg:'#1769ff'},'ë§ˆê°':{bg:'#fef2f2',bd:'#fee2e2',fg:'#ef4444'},'ìƒíƒœë¯¸ì •':{bg:'#f1f5fb',bd:'#e4ecf7',fg:'#334155'}}; const c=m[st]||m['ìƒíƒœë¯¸ì •']; return `<span class="badge" style="background:${c.bg};border-color:${c.bd};color:${c.fg}">${st}</span>`;}

/* ===== ëª©ë¡/í•„í„° ===== */
let TOURS={}, TOUR_ARRAY=[];
async function loadTournaments(){ const j=await getJSON(apiUrl('tournaments')); TOURS={}; TOUR_ARRAY=j.rows||[]; TOUR_ARRAY.forEach(t=>TOURS[t.TourID]=t); renderTournamentList(); renderTourFilter();}
function renderTournamentList(){ const box=$('#tourList'); box.innerHTML=(TOUR_ARRAY||[]).map(t=>{const range=(t.start||t.end)?`${fmtDate(t.start)} ~ ${fmtDate(t.end)}`:'ì¼ì •ë¯¸ì •'; const st=calcStatus(t.regStart,t.regEnd); return `<div class="pill" data-id="${t.TourID}"><b>${t.name}</b> Â· ${st} Â· ${range}</div>`}).join(''); box.querySelectorAll('.pill').forEach(el=>el.addEventListener('click', async()=>{ if(!(await confirmDiscardIfDirty()))return; loadTourToForm(TOURS[el.dataset.id],true); $('#editBtn').disabled=false; }));}
function renderTourFilter(){ const sel=$('#tourFilter'); const cur=sel.value; sel.innerHTML='<option value="">ì „ì²´ ëŒ€íšŒ</option>'; TOUR_ARRAY.forEach(t=>{const o=document.createElement('option'); o.value=t.TourID; o.textContent=t.name; sel.appendChild(o)}); if(TOUR_ARRAY.find(x=>x.TourID===cur)) sel.value=cur;}

/* ===== íŒ€ í‘œ ===== */
function jerseySVG(hex,label){const color=(/^#[0-9a-f]{6}$/i).test(hex||'')?hex:'#e5e7eb', text=(label||'').toUpperCase(); return `<svg width="42" height="52" viewBox="0 0 42 52" xmlns="http://www.w3.org/2000/svg"><g filter="url(#s)"><path d="M14 3 l4 6 h6 l4-6 h6 v15 l3 3 v27 a3 3 0 0 1 -3 3 h-26 a3 3 0 0 1 -3 -3 v-27 l3-3 v-15 z" fill="${color}" stroke="#cbd5e1"/><text x="21" y="31" font-family="system-ui,sans-serif" font-size="9" fill="#0f172a" text-anchor="middle" font-weight="700">${text}</text></g><defs><filter id="s" x="0" y="0" width="42" height="52"><feDropShadow dx="0" dy="1" stdDeviation="1" flood-color="#000" flood-opacity=".08"/></filter></defs></svg>`;}
function normalizeTeamRow(r){const region=[r.ì‹œë„||r.province||'',r.ì‹œêµ°êµ¬||r.city||''].join(' ').trim(); const cat=r.ì¢…ë³„||r.category||'', div=r.ë””ë¹„ì „||r.division||''; function pickHex(p,f){if(typeof p==='string'&&/^#[0-9a-f]{6}$/i.test(p))return p.toLowerCase(); if(typeof f==='string'){const m=f.match(/#([0-9a-f]{6})/i); if(m)return('#'+m[1]).toLowerCase();} return '';} const homeHex=pickHex(r.uniformHomeHex,r['ìœ ë‹ˆí¼(í™ˆ)']), awayHex=pickHex(r.uniformAwayHex,r['ìœ ë‹ˆí¼(ì–´ì›¨ì´)']); return {teamId:r.TeamID||r.teamId||'',tourId:(r.TourID||r.tourId||'').toString().trim(),tourName:r.tourName||r.TourName||r['ëŒ€íšŒëª…']||'',region,teamName:r.íŒ€ëª…||r.teamName||'',managerName:r.ëŒ€í‘œìì´ë¦„||r.managerName||'',managerPhone:r.ëŒ€í‘œìì—°ë½ì²˜||r.managerPhone||'',category:cat,division:div,homeHex,awayHex,createdAt:r.ì‹ ì²­ì¼ì‹œ||r.createdAt||'',editCode:r.ìˆ˜ì •ì½”ë“œ||r.editCode||''};}
function rowTeam(v){return `<tr><td>${v.teamId}</td><td>${v.tourName||'-'}</td><td>${v.region||'-'}</td><td><div><b>${v.teamName||''}</b></div><div class="muted">${v.managerName||''} Â· ${v.managerPhone||''}</div></td><td>${v.category||''} Â· ${v.division||''}</td><td><div class="jersey">${jerseySVG(v.homeHex,'HOME')}${jerseySVG(v.awayHex,'AWAY')}</div></td><td>${fmtDate(v.createdAt)}</td><td class="right"><a class="btn" href="${editUrlFor(v.teamId,v.editCode)}" target="_blank" rel="noopener">ìˆ˜ì • ì—´ê¸°</a></td></tr>`;}
function editUrlFor(teamId,editCode){const base=APPLY_BASE.replace(/index\.html$/,''); const sep=base.endsWith('/')?'':'/'; return `${base}${sep}?edit=${encodeURIComponent(teamId)}&code=${encodeURIComponent(editCode||'')}`;}
async function loadTeams(){ try{const tourId=($('#tourFilter').value||'').trim(); const j=await getJSON(apiUrl('teams',tourId?{tourId}:{}) ); let rows=Array.isArray(j.rows)?j.rows:[]; if(tourId) rows=rows.filter(r=>String(r.TourID||r.tourId||'').trim()===tourId); const q=($('#searchText').value||'').trim().toLowerCase(); if(q){ rows=rows.filter(r=>{const v=normalizeTeamRow(r);return[v.teamId,v.tourName,v.region,v.teamName,v.managerName,v.managerPhone,v.category,v.division].join(' ').toLowerCase().includes(q);}); } $('#teamsTbody').innerHTML= rows.map(r=>rowTeam(normalizeTeamRow(r))).join('') || `<tr><td colspan="8" class="muted">ë°ì´í„° ì—†ìŒ</td></tr>`; }catch(e){ $('#teamsTbody').innerHTML=`<tr><td colspan="8" class="muted">ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: ${e.message}</td></tr>`; }}

/* ===== ì¢…ë³„ ì¹© + ëª¨ë‹¬ ===== */
const DIVISION_PRESETS={'ì¼ë°˜ë¶€':['D3','D4','D5','D6','D7'],'ëŒ€í•™ë¶€':['U1','U2','U3','UW'],'ì—¬ì„±ë¶€':['D3','D4','D5'],'ìœ ì†Œë…„ë¶€':['í•˜ëª¨ë‹ˆ','i1','i2','i3','i4']};
let DIV_STATE=[];
function renderDivChips(box,group,vals,editable){ const row=el(`<div class="place-item"></div>`); const left=el(`<div><b>${group}</b></div>`); const chips=el(`<div class="chips"></div>`); chips.innerHTML=vals.length?vals.map(v=>`<span class="chip" data-v="${v}" title="${editable?'í´ë¦­í•˜ì—¬ ì œê±°':''}">${v}${editable?' Ã—':''}</span>`).join(''):`<span class="muted">ë¯¸ì„ íƒ</span>`; if(editable){ chips.querySelectorAll('.chip').forEach(c=>c.addEventListener('click',()=>{const v=c.getAttribute('data-v'); const set=DIV_STATE.find(s=>s.group===group); if(set){ set.divisions=set.divisions.filter(x=>x!==v); DIRTY=true; refreshDivUI(); }})); } const right=el(`<div class="right"></div>`); if(editable){ const del=el(`<button class="btn danger">ì‚­ì œ</button>`); del.addEventListener('click',()=>{DIV_STATE=DIV_STATE.filter(s=>s.group!==group); DIRTY=true; refreshDivUI();}); right.appendChild(del);} row.appendChild(left); row.appendChild(chips); row.appendChild(el(`<div></div>`)); row.appendChild(el(`<div></div>`)); row.appendChild(right); box.appendChild(row);}
function refreshDivUI(){ const box=$('#divSetList'); box.innerHTML=''; const editable=!FORM_LOCKED; if(DIV_STATE.length){ DIV_STATE.forEach(s=>renderDivChips(box,s.group,s.divisions||[],editable)); } $('#addDivSetBtn').disabled=FORM_LOCKED; }

/* ëª¨ë‹¬ */
const divModal=$('#divModal'), divGroupSel=$('#divGroupSel'), divChecks=$('#divChecks');
function openDivModal(){ if(FORM_LOCKED)return; divGroupSel.innerHTML=Object.keys(DIVISION_PRESETS).map(g=>`<option value="${g}">${g}</option>`).join(''); renderDivChecks(divGroupSel.value); divModal.style.display='flex'; setTimeout(()=>divGroupSel.focus(),0); }
function closeDivModal(){ divModal.style.display='none'; }
function renderDivChecks(g){ const opts=DIVISION_PRESETS[g]||[]; divChecks.innerHTML=opts.map(v=>{const id='div_'+g+'_'+v+'_'+Math.random().toString(36).slice(2,7); return `<label style="display:flex;gap:6px;align-items:center;border:1px solid #e6ecf5;border-radius:999px;padding:6px 10px"><input type="checkbox" value="${v}" id="${id}"><span>${v}</span></label>`;}).join('');}
$('#divGroupSel').addEventListener('change',()=>renderDivChecks(divGroupSel.value));
$('#divApplyBtn').addEventListener('click',()=>{ const g=divGroupSel.value; const picked=[...divChecks.querySelectorAll('input:checked')].map(i=>i.value); if(!picked.length){alert('ì¢…ë³„ì„ ì„ íƒí•˜ì„¸ìš”.');return;} let set=DIV_STATE.find(s=>s.group===g); if(!set){set={group:g,divisions:[]}; DIV_STATE.push(set);} picked.forEach(v=>{if(!set.divisions.includes(v)) set.divisions.push(v);}); closeDivModal(); DIRTY=true; refreshDivUI();});
$('#divCloseBtn').addEventListener('click',closeDivModal);
$('#addDivSetBtn').addEventListener('click',openDivModal);

/* ===== ì£¼ì†Œ íŒì—… (3ë‹¨ê³„ í´ë°±) ===== */
let addrPickTargetRow=null;
function openJusoPopup(targetRow=null){
  if(FORM_LOCKED) return;
  addrPickTargetRow=targetRow;
  const url=`https://www.juso.go.kr/addrlink/addrLinkUrl.do?confmKey=${encodeURIComponent(JUSO_KEY)}&returnUrl=${encodeURIComponent(JUSO_RETURN)}&resultType=4`;
  const features='width=570,height=600,scrollbars=yes,resizable=yes';
  // 1) ê¸°ë³¸
  let w=window.open(url,'jusoPopup',features);
  // 2) íŒì—…ì°¨ë‹¨ ì‹œ a[target] í´ë°±
  if(!w || w.closed || typeof w.closed==='undefined'){
    const a=document.createElement('a');
    a.href=url; a.target='jusoPopup'; a.rel='noopener';
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>a.remove(),0);
  }
  // 3) ê·¸ë˜ë„ ë§‰íˆë©´ ìƒˆ íƒ­
  setTimeout(()=>{ try{
    if(!w || w.closed || typeof w.closed==='undefined'){
      const b=document.createElement('a');
      b.href=url; b.target='_blank'; b.rel='noopener';
      document.body.appendChild(b); b.click(); setTimeout(()=>b.remove(),0);
    }
  }catch(_){/* ignore */}}, 150);
}
window.__onJusoSelected=function(d){
  const v={ name:d.bdNm||d.roadAddr||d.roadAddrPart1||'', address:d.roadAddr||[d.roadAddrPart1||'',d.roadAddrPart2||''].join(' ').trim(), lat:parseFloat(d.entY||''), lng:parseFloat(d.entX||'') };
  if(addrPickTargetRow){ fillPlaceRow(addrPickTargetRow,v); } else { const row=makePlaceRow({}); $('#placeList').appendChild(row); fillPlaceRow(row,v); }
  DIRTY=true; addrPickTargetRow=null;
};

/* ì¥ì†Œ í–‰ */
function makePlaceRow(init={name:'',address:'',lat:'',lng:''}){
  const row=el(`<div class="place-item"></div>`);
  const name=el(`<div><label style="margin:0 0 6px">ì¥ì†Œëª…</label><input value="${init.name||''}" data-editable placeholder="ì˜ˆ: ì„œìš¸ëŒ€í•™êµ ì¢…í•©ì²´ìœ¡ê´€"></div>`);
  const addr=el(`<div><label style="margin:0 0 6px">ì£¼ì†Œ</label><input value="${init.address||''}" data-editable placeholder="íŒì—…ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”"></div>`);
  const lat =el(`<div><label style="margin:0 0 6px">ìœ„ë„</label><input value="${init.lat||''}" data-editable placeholder="37.xxxxxx"></div>`);
  const lng =el(`<div><label style="margin:0 0 6px">ê²½ë„</label><input value="${init.lng||''}" data-editable placeholder="126.xxxxxx"></div>`);
  const ctrl=el(`<div style="display:flex;gap:6px;align-items:flex-end"><button class="btn" data-research data-editable>ì¬ê²€ìƒ‰</button><button class="btn danger" data-del data-editable>ì‚­ì œ</button></div>`);
  ctrl.querySelector('[data-research]').addEventListener('click',()=>openJusoPopup(row));
  ctrl.querySelector('[data-del]').addEventListener('click',()=>{row.remove(); DIRTY=true;});
  row.appendChild(name); row.appendChild(addr); row.appendChild(lat); row.appendChild(lng); row.appendChild(ctrl);
  row.getValue=()=>({name:name.querySelector('input').value.trim(), address:addr.querySelector('input').value.trim(), lat:parseFloat(lat.querySelector('input').value), lng:parseFloat(lng.querySelector('input').value)});
  return row;
}
function fillPlaceRow(row,v){ const [n,a,la,ln]=row.querySelectorAll('input'); if(v.name) n.value=v.name; if(v.address) a.value=v.address; if(isFinite(v.lat)) la.value=Number(v.lat).toFixed(6); if(isFinite(v.lng)) ln.value=Number(v.lng).toFixed(6); }
function getPlaces(){ return [...document.querySelectorAll('#placeList .place-item')].map(it=>it.getValue()).filter(p=>p.name||p.address||(p.lat&&p.lng)); }
function setPlaces(list){ const box=$('#placeList'); box.innerHTML=''; (list&&list.length?list:[]).forEach(v=>box.appendChild(makePlaceRow(v))); }

/* ===== í¼ ìƒíƒœ ===== */
let FORM_LOCKED=true, DIRTY=false, CURRENT_TOUR_ID='';
function setLocked(locked){
  FORM_LOCKED=locked; const area=$('#formArea'); if(locked) area.classList.add('locked'); else area.classList.remove('locked');
  document.querySelectorAll('[data-editable]').forEach(e=>e.disabled=locked);
  const admin=$('#adminCode'); if(locked){admin.setAttribute('readonly','');} else {admin.addEventListener('focus',()=>admin.removeAttribute('readonly'),{once:true});}
  $('#saveTourBtn').disabled=locked; $('#deleteTourBtn').disabled=locked||!CURRENT_TOUR_ID; $('#addDivSetBtn').disabled=locked; $('#addPlaceBtn').disabled=locked;
}
function markDirty(){ if(!FORM_LOCKED) DIRTY=true; }
document.addEventListener('input',(e)=>{ if(e.target.matches('[data-editable]')) markDirty(); });
window.addEventListener('beforeunload',(e)=>{ if(DIRTY){ e.preventDefault(); e.returnValue=''; }});
async function confirmDiscardIfDirty(){ if(!DIRTY) return true; const ok=confirm('ì €ì¥í•˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. ê³„ì† ì§„í–‰í• ê¹Œìš”?'); if(ok) DIRTY=false; return ok; }

/* ===== í¼ ë¡œë“œ/ì´ˆê¸°í™” ===== */
function updateStatusBadge(){ $('#tourStatusBadge').innerHTML=statusBadgeHtml(calcStatus($('#regStart').value||'',$('#regEnd').value||'')); }
['regStart','regEnd'].forEach(id=>$('#'+id).addEventListener('change',updateStatusBadge));

function loadTourToForm(t,locked=true){
  CURRENT_TOUR_ID=t?.TourID||''; $('#tourFormTitle').textContent=t?'ëŒ€íšŒ ìˆ˜ì • (ì½ê¸° ì „ìš©)':'ëŒ€íšŒ ë“±ë¡';
  $('#tourId').value=t?.TourID||''; $('#tourName').value=t?.name||''; $('#tourUrl').value=t?.url||'';
  $('#tourStart').value=toInputDateOnly(t?.start); $('#tourEnd').value=toInputDateOnly(t?.end);
  $('#regStart').value=toInputDT(t?.regStart); $('#regEnd').value=toInputDT(t?.regEnd); updateStatusBadge();
  let ds=t?.divSets; if(!Array.isArray(ds)||!ds.length){ const m=t?.divs||{}; ds=Object.keys(m).map(g=>({group:g,divisions:m[g]||[]})); }
  DIV_STATE=(ds||[]).map(s=>({group:s.group, divisions:[...(s.divisions||[])]})); refreshDivUI();
  setPlaces(Array.isArray(t?.places)?t.places:[]); $('#adminCode').value=''; DIRTY=false; setLocked(locked);
}
function clearTourForm(){
  CURRENT_TOUR_ID=''; $('#tourFormTitle').textContent='ëŒ€íšŒ ë“±ë¡';
  ['tourId','tourName','tourUrl','tourStart','tourEnd','regStart','regEnd','adminCode'].forEach(id=>$('#'+id).value='');
  DIV_STATE=[]; refreshDivUI(); setPlaces([]); updateStatusBadge(); DIRTY=false; setLocked(false); $('#editBtn').disabled=true;
}

/* ===== ì €ì¥/ì‚­ì œ ===== */
$('#toggleCodeBtn').addEventListener('click',()=>{const i=$('#adminCode'); i.type=(i.type==='password'?'text':'password');});
async function saveTournament(){
  const name=($('#tourName').value||'').trim(); if(!name) return alert('ëŒ€íšŒëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
  const adminCode=($('#adminCode').value||'').trim(); if(!adminCode) return alert('ê´€ë¦¬ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
  const divs={}; DIV_STATE.forEach(s=>{ if(!divs[s.group]) divs[s.group]=[]; (s.divisions||[]).forEach(d=>{ if(!divs[s.group].includes(d)) divs[s.group].push(d); }); });
  const payload={ tourId:($('#tourId').value||'').trim(), name, start:$('#tourStart').value||'', end:$('#tourEnd').value||'', regStart:$('#regStart').value||'', regEnd:$('#regEnd').value||'', status:calcStatus($('#regStart').value||'',$('#regEnd').value||''), url:($('#tourUrl').value||'').trim(), divSets:DIV_STATE, divs, places:getPlaces(), adminCode };
  const j=await postJSON('upsertTournament',payload); if(!j.ok) return alert('ì €ì¥ ì‹¤íŒ¨: '+(j.error||'unknown'));
  await loadTournaments(); if(j.tourId) $('#tourId').value=j.tourId; alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); DIRTY=false; setLocked(true); $('#tourFormTitle').textContent='ëŒ€íšŒ ìˆ˜ì • (ì½ê¸° ì „ìš©)';
}
$('#saveTourBtn').addEventListener('click',async()=>{ if(!confirm('ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return; try{await saveTournament();}catch(e){alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜: '+e.message);} });
$('#deleteTourBtn').addEventListener('click',async()=>{ const id=($('#tourId').value||'').trim(); if(!id) return alert('ì‚­ì œí•  ëŒ€íšŒê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return; const code2=prompt('ëŒ€íšŒê´€ë¦¬ ì½”ë“œë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”:',''); if(!code2) return alert('ê´€ë¦¬ì½”ë“œê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); try{const j=await postJSON('removeTournament',{tourId:id,adminCode:code2}); if(!j.ok) return alert('ì‚­ì œ ì‹¤íŒ¨: '+(j.error||'unknown')); clearTourForm(); await loadTournaments(); alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); }catch(e){ alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜: '+e.message);} });

/* ===== ìƒë‹¨ ë²„íŠ¼ ===== */
$('#settingsBtn').addEventListener('click',()=>{ const cur=(conf.appUrl||'').trim(); const val=prompt('Apps Script Web App URLì„ ì…ë ¥í•˜ì„¸ìš”:',cur); if(val===null) return; conf.appUrl=(val||'').trim(); store.save(conf); alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.'); location.reload();});
$('#reloadBtn').addEventListener('click',async()=>{ if(!(await confirmDiscardIfDirty())) return; await health(); await loadTournaments(); await loadTeams(); });
$('#newTourBtn').addEventListener('click',async()=>{ if(!(await confirmDiscardIfDirty())) return; clearTourForm(); });
$('#editBtn').addEventListener('click',()=>{ if(!CURRENT_TOUR_ID) return alert('ìˆ˜ì •í•  ëŒ€íšŒë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.'); const code=prompt('ëŒ€íšŒê´€ë¦¬ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:',''); if(!code) return; $('#adminCode').value=code; setLocked(false); $('#tourFormTitle').textContent='ëŒ€íšŒ ìˆ˜ì • (í¸ì§‘ ê°€ëŠ¥)'; });
$('#tourFilter').addEventListener('change',async()=>{ if(!(await confirmDiscardIfDirty())){$('#tourFilter').value=''; return;} loadTeams(); });
$('#searchBtn').addEventListener('click',loadTeams);
$('#searchText').addEventListener('keydown',e=>{ if(e.key==='Enter') loadTeams(); });

/* ===== ë¶€íŠ¸ ===== */
(async function boot(){ if(!conf.appUrl){ alert('ì²˜ìŒ ì‚¬ìš©ì´ë¼ë©´ âš™ï¸ì—ì„œ Web App URLì„ ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”.'); return; } await health(); await loadTournaments(); await loadTeams(); updateStatusBadge();})();
</script>
</body>
</html>

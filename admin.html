<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BDR ê´€ë¦¬ì</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --blue:#1769ff; --bg:#f6f8fb; --card:#fff; --muted:#6b7684; --red:#ef4444; --green:#16a34a }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:'Pretendard','Apple SD Gothic Neo',sans-serif;color:#222}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px 64px}
  header{display:flex;justify-content:space-between;align-items:center;margin:10px 0 18px}
  h1{font-size:20px;margin:0}
  .card{background:var(--card);border-radius:14px;box-shadow:0 8px 28px rgba(23,105,255,.08);padding:16px;margin-top:16px}
  .row{display:grid;gap:12px}
  @media(min-width:720px){ .row-2{grid-template-columns:1.2fr 2fr} .row-3{grid-template-columns:1fr 1fr 1fr} }
  label{display:block;font-weight:600;margin:10px 0 6px}
  input,select,textarea{width:100%;padding:12px;border:1px solid #e6ecf5;border-radius:12px;font-size:14px;outline:none;background:#fff}
  input:focus,select:focus,textarea:focus{border-color:var(--blue)}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid #dfe6ee;background:#fff;cursor:pointer}
  .btn.primary{background:var(--blue);color:#fff;border-color:var(--blue)}
  .btn.danger{background:#fff;color:#ef4444;border-color:#ffd1d1}
  .btn.ghost{background:#fff;color:#334155;border-color:#e6ecf5}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted);font-size:12px}
  .grid{display:grid;gap:10px}
  .grid-2{grid-template-columns:1fr 1fr}
  .pill{display:inline-block;border:1px solid #e6ecf5;border-radius:999px;padding:6px 10px;font-size:12px;margin:2px 0;background:#fff;cursor:pointer;user-select:none;transition:background .12s, box-shadow .12s}
  .pill:hover{ background:#f8fbff; box-shadow:0 2px 6px rgba(23,105,255,.15) }
  .hr{height:1px;background:#eef2f7;margin:8px 0}
  .badge{display:inline-flex;gap:8px;align-items:center;font-size:12px;color:#334155;background:#f1f5fb;border:1px solid #e4ecf7;border-radius:999px;padding:4px 8px}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px solid #e6ecf5;border-radius:999px;padding:6px 10px;font-size:12px;background:#fff;cursor:pointer}
  .place-item{display:grid;gap:8px;grid-template-columns:1.7fr 1fr 1fr auto;align-items:center;border:1px solid #e6ecf5;border-radius:12px;padding:10px;background:#fff}
  .locked *[data-editable]{pointer-events:none; opacity:.9}
  .input-icon{position:relative}
  .eye-btn{position:absolute;right:10px;top:50%;transform:translateY(-50%);border:0;background:transparent;cursor:pointer;font-size:16px}
  .offscreen{position:absolute;left:-9999px;opacity:0;width:0;height:0;pointer-events:none}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  th{font-size:12px;color:#5b6472;text-align:left;padding:0 10px}
  td{background:#fff;padding:12px 10px;border-top:1px solid #eef2f7;border-bottom:1px solid #eef2f7}
  tr td:first-child{border-left:1px solid #eef2f7;border-radius:12px 0 0 12px}
  tr td:last-child{border-right:1px solid #eef2f7;border-radius:0 12px 12px 0}
  .jersey{display:inline-flex;align-items:center;gap:6px}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:.15s;z-index:9998}
  .overlay.show{opacity:1;pointer-events:auto}
  .popover{position:fixed;min-width:320px;max-width:92vw;background:#fff;border:1px solid #e6ecf5;border-radius:14px;box-shadow:0 12px 30px rgba(0,0,0,.16);opacity:0;transform:translate(-50%,-6px);transition:.15s;z-index:9999;left:50%;top:13%}
  .popover.show{opacity:1;transform:translate(-50%,0)}
  .pop-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #eef2f7;font-weight:700}
  .pop-body{padding:12px}
  .pop-actions{display:flex;gap:8px;justify-content:flex-end;padding:10px 12px;border-top:1px solid #eef2f7}
  .poster-box{display:grid;gap:10px}
  .poster-preview{display:flex;align-items:center;gap:12px}
  .poster-preview img{max-width:220px;max-height:220px;border-radius:12px;border:1px solid #e6ecf5;object-fit:contain;background:#fff}
  .poster-drop{border:1px dashed #cbd5e1;border-radius:12px;padding:12px;text-align:center;color:#64748b;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>BDR ê´€ë¦¬ì</h1>
    <div class="toolbar" title="ì—°ê²°ìƒíƒœ">
      <span class="muted" id="healthDot" style="display:inline-block">â—</span>
      <button class="btn" id="settingsBtn">âš™ï¸ ì„¤ì •</button>
      <button class="btn" id="reloadBtn">ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </header>

  <!-- ìë™ì™„ì„± íŠ¸ë© -->
  <input class="offscreen" type="text" autocomplete="username" />
  <input class="offscreen" type="password" autocomplete="current-password" />

  <!-- ëŒ€íšŒ í•„í„° -->
  <div class="card">
    <div class="row row-3">
      <div>
        <label>ëŒ€íšŒ í•„í„°</label>
        <select id="tourFilter"><option value="">ì „ì²´ ëŒ€íšŒ</option></select>
      </div>
      <div class="muted" style="align-self:end">â€» âš™ï¸ì—ì„œ Apps Script Web App URLì„ ë³€ê²½/í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    </div>
  </div>

  <!-- ëŒ€íšŒ ê´€ë¦¬ -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0;font-size:16px">ëŒ€íšŒ ê´€ë¦¬</h3>
      <div class="toolbar">
        <button class="btn" id="newTourBtn">ì‹ ê·œ ëŒ€íšŒ</button>
        <button class="btn" id="editBtn" disabled>ìˆ˜ì •</button>
      </div>
    </div>

    <div class="row row-2">
      <!-- ì¢Œ ëª©ë¡ -->
      <div>
        <label>ëŒ€íšŒ ëª©ë¡</label>
        <div id="tourList" class="grid"></div>
      </div>

      <!-- ìš° í¼ -->
      <div id="formArea" class="locked">
        <label id="tourFormTitle">ëŒ€íšŒ ë“±ë¡/ìˆ˜ì •</label>

        <div class="grid">
          <input id="tourId" placeholder="ìë™ìƒì„± (ìˆ˜ì • ì‹œ ê³ ì •)" disabled>
          <input id="tourName" placeholder="ëŒ€íšŒëª…" data-editable>
          <input id="tourUrl" placeholder="ì•ˆë‚´ í˜ì´ì§€ URL (ì„ íƒ)" data-editable inputmode="url" autocomplete="off" spellcheck="false">
        </div>

        <label class="muted" style="margin-top:8px">ì¢…ë³„ ì„¤ì •</label>
        <div class="muted" style="margin-top:-6px">í¸ì§‘ ëª¨ë“œì—ì„œë§Œ <b>+ êµ¬ë¶„/ì¢…ë³„ ì¶”ê°€</b> ì‚¬ìš© ê°€ëŠ¥. ì‹ ê·œ ëŒ€íšŒëŠ” ë²„íŠ¼ë§Œ ë³´ì…ë‹ˆë‹¤.</div>
        <div id="divSetList" class="grid" style="margin-top:8px"></div>
        <div class="toolbar" style="margin-top:6px;justify-content:space-between">
          <button class="btn danger" id="clearAllDivBtn" data-editable disabled>ì¢…ë³„êµ¬ë¶„ ì „ì²´ ì‚­ì œ</button>
          <button class="btn ghost" id="addDivSetBtn" data-editable disabled>+ êµ¬ë¶„/ì¢…ë³„ ì¶”ê°€</button>
        </div>

        <div class="hr"></div>

        <label>ëŒ€íšŒì¥ì†Œ</label>
        <div class="muted" style="margin-top:-6px">+ ì¥ì†Œ ì¶”ê°€ â†’ ì¥ì†Œëª…ë§Œ ì…ë ¥í•©ë‹ˆë‹¤.</div>
        <div id="placeList" class="grid" style="margin-top:8px"></div>
        <div class="toolbar" style="margin-top:6px;justify-content:flex-end">
          <button class="btn ghost" id="addPlaceBtn" data-editable disabled>+ ì¥ì†Œ ì¶”ê°€</button>
        </div>

        <div class="hr"></div>

        <!-- í¬ìŠ¤í„° ì—…ë¡œë“œ -->
        <label>ëŒ€íšŒ í¬ìŠ¤í„°</label>
        <div id="posterBox" class="poster-box">
          <div class="poster-preview" id="posterPreview"></div>
          <div class="toolbar" style="justify-content:space-between">
            <div class="muted">
              <label><input type="checkbox" id="posterEmbed"> ì‹œíŠ¸ urlì— ì €ì¥(ë°ì´í„°URL)</label>
            </div>
            <div class="toolbar">
              <button class="btn" id="posterCopy" disabled>ì£¼ì†Œ ë³µì‚¬</button>
              <button class="btn danger" id="posterClear" disabled>í¬ìŠ¤í„° ì œê±°</button>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <label>ëŒ€íšŒê¸°ê°„</label>
        <div class="grid grid-2">
          <input id="tourStart" type="date" placeholder="ì‹œì‘ì¼" data-editable>
          <input id="tourEnd" type="date" placeholder="ì¢…ë£Œì¼" data-editable>
        </div>

        <label style="margin-top:10px">ì ‘ìˆ˜ê¸°ê°„</label>
        <div class="grid grid-2">
          <input id="regStart" type="datetime-local" placeholder="ì ‘ìˆ˜ ì‹œì‘" data-editable>
          <input id="regEnd" type="datetime-local" placeholder="ì ‘ìˆ˜ ì¢…ë£Œ" data-editable>
        </div>

        <div class="grid grid-2" style="margin-top:12px;align-items:end">
          <div>
            <label>ëŒ€íšŒê´€ë¦¬ ì½”ë“œ (í•„ìˆ˜)</label>
            <div class="input-icon">
              <input id="adminCode" type="password" placeholder="ì´ ëŒ€íšŒë¥¼ ê´€ë¦¬í•  ë¹„ë°€ë²ˆí˜¸" data-editable autocomplete="new-password" readonly>
              <button class="eye-btn" id="toggleCodeBtn" title="ë³´ê¸°/ìˆ¨ê¸°ê¸°">ğŸ‘ï¸</button>
            </div>
            <div style="margin-top:8px">
              <label>ìƒíƒœ(ìë™)</label>
              <div id="tourStatusBadge" class="badge">ìƒíƒœë¯¸ì •</div>
            </div>
          </div>
          <div class="toolbar" style="justify-content:flex-end;gap:8px">
            <button class="btn danger" id="deleteTourBtn" data-editable disabled>ì‚­ì œ</button>
            <button class="btn primary" id="saveTourBtn" data-editable disabled>ì €ì¥</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- íŒ€/ì„ ìˆ˜ -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0;font-size:16px">íŒ€ / ì„ ìˆ˜</h3>
      <div class="toolbar">
        <input id="searchText" placeholder="íŒ€ëª…/ëŒ€í‘œì/ì—°ë½ì²˜ ê²€ìƒ‰" style="width:140px">
        <button class="btn" id="searchBtn">ê²€ìƒ‰</button>
      </div>
    </div>

    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>íŒ€ID</th><th>ëŒ€íšŒ</th><th>ì§€ì—­</th><th>íŒ€ëª… / ëŒ€í‘œ</th><th>ì¢…ë³„Â·ë””ë¹„ì „</th><th>ìœ ë‹ˆí¼</th><th>ì‹ ì²­ì¼ì‹œ</th><th></th>
          </tr>
        </thead>
        <tbody id="teamsTbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Floating base -->
<div id="overlay" class="overlay"></div>
<div id="popover" class="popover" role="dialog" aria-modal="true" style="display:none">
  <div class="pop-head"><span id="popTitle">ì œëª©</span><button class="btn" id="popCloseBtn">ë‹«ê¸°</button></div>
  <div class="pop-body" id="popBody"></div>
  <div class="pop-actions" id="popActions"></div>
</div>

<script>
/* ===== ìƒíƒœ ì  ìƒ‰ìƒ ===== */
function setHealth(color, tip){ const dot=document.getElementById('healthDot'); dot.style.color=color; if(tip) dot.title=tip; }

/* ===== ê³ ì •ëœ Web App URL (ê¸°ë³¸) ===== */
const WEB_APP_URL='https://script.google.com/macros/s/AKfycbz1qk5MbQvVU3d8Qs3EcPO792iBNlVQR71WhCpNbkqzCcdn5gM17Hqx9AUAIGUwwSKCww/exec';

/* ===== ì„¤ì • ì €ì¥ (ê¸°ì¡´ ì˜¤ì—¼ íšŒí”¼: V2 í‚¤ ì‚¬ìš©) ===== */
const CONF_KEY='BDR_ADMIN_CONF_V2';
const store={ load(){ try{ return JSON.parse(localStorage.getItem(CONF_KEY)||'{}'); }catch{return{};} }, save(o){ localStorage.setItem(CONF_KEY, JSON.stringify(o||{})); } };
function validWebAppUrl(u){ return /^https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec(\?.*)?$/i.test((u||'').trim()); }
let conf=store.load();
/* âœ… ë¡œì»¬ ê°’ì´ ë¹„ì •ìƒì¸ ê²½ìš° ê¸°ë³¸ URLë¡œ ìë™ ë³µêµ¬ */
if(!validWebAppUrl(conf.appUrl)) { conf.appUrl = WEB_APP_URL; store.save(conf); }

/* ===== DOM í—¬í¼ ===== */
const $=s=>document.querySelector(s);
const el=h=>{ const t=document.createElement('template'); t.innerHTML=h.trim(); return t.content.firstElementChild; };

/* ===== API ===== */
function apiUrl(path,q={}){     /* âœ… ì˜ˆì™¸ ë°©ì§€: í•­ìƒ ì •ìƒ URL ë³´ì¥ */
  let base=(conf.appUrl||'').trim();
  if(!validWebAppUrl(base)){ base=WEB_APP_URL; conf.appUrl=base; store.save(conf); }
  const u=new URL(base);
  u.searchParams.set('path', path);
  Object.entries(q).forEach(([k,v])=>u.searchParams.set(k,v));
  return u.toString();
}
async function getJSON(u){
  const r=await fetch(u, {cache:'no-store', mode:'cors', credentials:'omit'});
  const text=await r.text();
  try{ return JSON.parse(text); }
  catch(e){ console.error('[getJSON] parse fail', text.slice(0,160)); throw new Error('JSON íŒŒì‹± ì‹¤íŒ¨ / ê¶Œí•œ ë˜ëŠ” URL í™•ì¸'); }
}
async function postJSONCompat(paths, payload){
  const tryOnce = async (p)=>{
    const r=await fetch(apiUrl(p), {method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body:JSON.stringify(payload||{}), mode:'cors', credentials:'omit'});
    const t=await r.text();
    try{ return JSON.parse(t); }catch{ throw new Error('JSON íŒŒì‹± ì‹¤íŒ¨: '+t.slice(0,160)); }
  };
  let lastErr=null;
  for(const p of paths){ try{ const j=await tryOnce(p); if(j && (j.ok===true || j.ok==='true' || (j.rows!==undefined))) return j; } catch(e){ lastErr=e; } }
  if(lastErr) throw lastErr;
  return {ok:false,error:'unknown'};
}
async function postJSON(path, payload){ const camel=path, lower=path.toLowerCase(); const c=(camel===lower?[camel]:[camel,lower]); return postJSONCompat(c, payload); }

/* ===== ì—°ê²° ìƒíƒœ ===== */
async function health(){
  try{
    setHealth('#3b82f6','ì—°ê²° í™•ì¸ ì¤‘â€¦');                 // íŒŒë€ìƒ‰: ëŒ€ê¸°
    const j=await getJSON(apiUrl('health'));
    if(j && j.ok){ setHealth('#22c55e','ì—°ê²° ì •ìƒ'); return true; }
    setHealth('#ef4444','health ì‘ë‹µ ë¹„ì •ìƒ'); return false;
  }catch(e){
    setHealth('#ef4444','ì—°ê²° ì‹¤íŒ¨: '+e.message);
    return false;
  }
}

/* ===== ìœ í‹¸ ===== */
const pad=n=>String(n).padStart(2,'0');
function fmtDate(v){ if(!v) return ''; const d=new Date(v); if(isNaN(d)) return String(v); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function toInputDateOnly(s){ if(!s) return ''; if(typeof s==='string'){ const m=s.match(/^(\d{4}-\d{2}-\d{2})/); if(m) return m[1]; } const d=new Date(s); if(!isNaN(d)) return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; return ''; }
function toInputDT(s){ if(!s) return ''; if(typeof s==='string'){ const m=s.match(/^(\d{4}-\d{2}-\d{2})[ T](\d{2}):(\d{2})/); if(m) return `${m[1]}T${m[2]}:${m[3]}`; } const d=new Date(s); if(!isNaN(d)) return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; return ''; }
function calcStatus(rs,re){ if(!rs||!re) return 'ìƒíƒœë¯¸ì •'; const s=new Date(rs), e=new Date(re), n=new Date(); if(isNaN(s)||isNaN(e)) return 'ìƒíƒœë¯¸ì •'; if(n<s) return 'ì ‘ìˆ˜ì „'; if(n>e) return 'ë§ˆê°'; return 'ì ‘ìˆ˜ì¤‘'; }
function statusBadgeHtml(st){ const m={'ì ‘ìˆ˜ì¤‘':{bg:'#ecfdf5',bd:'#d1fae5',fg:'#16a34a'},'ì ‘ìˆ˜ì „':{bg:'#eff6ff',bd:'#dbeafe',fg:'#1769ff'},'ë§ˆê°':{bg:'#fef2f2',bd:'#fee2e2',fg:'#ef4444'},'ìƒíƒœë¯¸ì •':{bg:'#f1f5fb',bd:'#e4ecf7',fg:'#334155'}}; const c=m[st]||m['ìƒíƒœë¯¸ì •']; return `<span class="badge" style="background:${c.bg};border-color:${c.bd};color:${c.fg}">${st}</span>`; }

/* ===== ëª©ë¡/í•„í„° ===== */
let TOURS={}, TOUR_ARRAY=[];
async function loadTournaments(){
  try{
    const j=await getJSON(apiUrl('tournaments'));
    TOURS={}; TOUR_ARRAY=j.rows||[];
    TOUR_ARRAY.forEach(t=>{ const id=t.tourId||t.TourID||t.id; if(id) TOURS[id]=t; });
    renderTournamentList(); renderTourFilter();
  }catch(e){
    document.getElementById('tourList').innerHTML=`<div class="muted">ëŒ€íšŒ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`;
    renderTourFilter(true);
    setHealth('#ef4444','ëŒ€íšŒ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
  }
}
function tourCard(t){
  const id=t.tourId||t.TourID;
  const range=(t.start||t.end)?`${fmtDate(t.start)} ~ ${fmtDate(t.end)}`:'ì¼ì •ë¯¸ì •';
  const rs=t.regStart||t['reg.start']||t.reg_start||t.regStartDate||'';
  const re=t.regEnd||t['reg.end']||t.reg_end||t.regEndDate||'';
  const st=calcStatus(rs,re);
  return `<div class="pill" data-id="${id}" tabindex="0" role="button"><b>${t.name}</b> Â· ${st} Â· ${range}</div>`;
}
function renderTournamentList(){
  const box=$('#tourList');
  box.innerHTML=(TOUR_ARRAY||[]).map(t=>tourCard(t)).join('');
  box.querySelectorAll('.pill').forEach(el=>{
    el.addEventListener('click', async ()=>{
      if(!(await confirmDiscardIfDirty())) return;
      const id=el.getAttribute('data-id');
      const tour=TOURS[id];
      loadTourToForm(tour,true);
      document.getElementById('editBtn').disabled=false;
      document.getElementById('tourFilter').value=id;   // âœ… í•„í„° ë™ê¸°í™”
      await loadTeams();                                 // âœ… íŒ€ ëª©ë¡ í•¨ê»˜ ê°±ì‹ 
      document.getElementById('formArea').scrollIntoView({behavior:'smooth', block:'start'});
    });
  });
}
function renderTourFilter(failed=false){
  const sel=$('#tourFilter');
  const keep=sel.value;
  sel.innerHTML='<option value="">ì „ì²´ ëŒ€íšŒ</option>';
  if(failed){
    const opt=document.createElement('option'); opt.value=''; opt.textContent='(ì—°ê²° ì˜¤ë¥˜: âš™ï¸ URL í™•ì¸)'; sel.appendChild(opt); return;
  }
  (TOUR_ARRAY||[]).forEach(t=>{
    const id=t.tourId||t.TourID; if(!id) return;
    const period=(t.start||t.end)?` Â· ${toInputDateOnly(t.start)}~${toInputDateOnly(t.end)}`:'';
    const o=new Option(`${t.name||'(ë¬´ì œ)'}${period}`, id);
    sel.appendChild(o);
  });
  if(keep && [...sel.options].some(o=>o.value===keep)) sel.value=keep;
}

/* ===== íŒ€ í‘œ ===== */
function jerseySVG(hex,label){ const color=(/^[#][0-9a-f]{6}$/i).test(hex||'')?hex:'#e5e7eb', text=(label||'').toUpperCase(); return `<svg width="42" height="52" viewBox="0 0 42 52" xmlns="http://www.w3.org/2000/svg"><g filter="url(#s)"><path d="M14 3 l4 6 h6 l4-6 h6 v15 l3 3 v27 a3 3 0 0 1 -3 3 h-26 a3 3 0 0 1 -3 -3 v-27 l3-3 v-15 z" fill="${color}" stroke="#cbd5e1"/><text x="21" y="31" font-family="system-ui,sans-serif" font-size="9" fill="#0f172a" text-anchor="middle" font-weight="700">${text}</text></g><defs><filter id="s" x="0" y="0" width="42" height="52"><feDropShadow dx="0" dy="1" stdDeviation="1" flood-color="#000" flood-opacity=".08"/></filter></defs></svg>`; }
function normalizeTeamRow(r){
  const region=[r.province||'', r.city||''].join(' ').trim();
  const cat=r.category||'', div=r.division||'';
  function pickHex(p,f){ if(typeof p==='string'&&/^#[0-9a-f]{6}$/i.test(p))return p.toLowerCase(); if(typeof f==='string'){ const m=f.match(/#([0-9a-f]{6})/i); if(m)return('#'+m[1]).toLowerCase(); } return ''; }
  const homeHex=pickHex(r.uniformHome, r['ìœ ë‹ˆí¼(í™ˆ)']);
  const awayHex=pickHex(r.uniformAway, r['ìœ ë‹ˆí¼(ì–´ì›¨ì´)']);
  return {teamId:r.teamId||'', tourId:(r.tourId||'').toString().trim(), tourName:r.tourName||'', region, teamName:r.teamNameKo||r.teamName||'', managerName:r.managerName||'', managerPhone:r.managerPhone||'', category:cat, division:div, homeHex, awayHex, createdAt:r.createdAt||'' };
}
function rowTeam(v){
  return `<tr>
    <td>${v.teamId}</td>
    <td>${v.tourName||'-'}</td>
    <td>${v.region||'-'}</td>
    <td><div><b>${v.teamName||''}</b></div><div class="muted">${v.managerName||''} Â· ${v.managerPhone||''}</div></td>
    <td>${v.category||''} Â· ${v.division||''}</td>
    <td><div class="jersey">${jerseySVG(v.homeHex,'HOME')}${jerseySVG(v.awayHex,'AWAY')}</div></td>
    <td>${fmtDate(v.createdAt)}</td>
    <td class="right"><a class="btn" href="#" onclick="return false">ì—´ê¸°</a></td>
  </tr>`;
}
async function loadTeams(){
  try{
    const tourId=($('#tourFilter').value||'').trim();
    const j=await getJSON(apiUrl('teams', tourId?{tourId}:{}) );
    let rows=Array.isArray(j.rows)?j.rows:[];
    if(tourId) rows=rows.filter(r=>String(r.tourId||'').trim()===tourId);
    const q=($('#searchText').value||'').trim().toLowerCase();
    if(q){
      rows=rows.filter(r=>{
        const v=normalizeTeamRow(r);
        return [v.teamId,v.tourName,v.region,v.teamName,v.managerName,v.managerPhone,v.category,v.division].join(' ').toLowerCase().includes(q);
      });
    }
    $('#teamsTbody').innerHTML=rows.map(r=>rowTeam(normalizeTeamRow(r))).join('') || `<tr><td colspan="8" class="muted">ë°ì´í„° ì—†ìŒ</td></tr>`;
  }catch(e){
    $('#teamsTbody').innerHTML=`<tr><td colspan="8" class="muted">íŒ€ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</td></tr>`;
    setHealth('#ef4444','íŒ€ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
  }
}

/* ===== ìƒíƒœ/ì ê¸ˆ ===== */
let DIV_STATE=[];
let FORM_LOCKED=true, DIRTY=false, CURRENT_TOUR_ID='';
function setLocked(locked){
  FORM_LOCKED=locked;
  const area=$('#formArea');
  if(locked) area.classList.add('locked'); else area.classList.remove('locked');
  document.querySelectorAll('[data-editable]').forEach(e=> e.disabled=locked);
  const admin=$('#adminCode'); if(locked){ admin.setAttribute('readonly',''); } else { admin.addEventListener('focus', ()=> admin.removeAttribute('readonly'), {once:true}); }
  $('#saveTourBtn').disabled=locked;
  $('#deleteTourBtn').disabled=locked||!CURRENT_TOUR_ID;
  $('#addDivSetBtn').disabled=locked;
  $('#addPlaceBtn').disabled=locked;
  $('#clearAllDivBtn').disabled=locked || DIV_STATE.length===0;
}
function markDirty(){ if(!FORM_LOCKED) DIRTY=true; }
document.addEventListener('input',(e)=>{ if(e.target.matches('[data-editable]')) markDirty(); });
window.addEventListener('beforeunload',(e)=>{ if(DIRTY){ e.preventDefault(); e.returnValue=''; }});
async function confirmDiscardIfDirty(){ if(!DIRTY) return true; const ok=confirm('ì €ì¥í•˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. ê³„ì† ì§„í–‰í• ê¹Œìš”?'); if(ok) DIRTY=false; return ok; }

/* ===== ì¢…ë³„/ê´€ë¦¬ì½”ë“œ/ì¥ì†Œ(ìƒëµ: ê¸°ì¡´ê³¼ ë™ì¼) ===== */
/* (â€¦ì¤‘ëµ â€” ì¢…ë³„ í”Œë¡œíŒ…/ì¥ì†Œ í”Œë¡œíŒ…/ë Œë” í•¨ìˆ˜ëŠ” ì´ì „ ë²„ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€í–ˆìŠµë‹ˆë‹¤.) */

/* ===== í¬ìŠ¤í„° ì—…ë¡œë“œ ===== */
let POSTER_DATA_URL='';
function renderPoster(){
  const prev=$('#posterPreview');
  if(!POSTER_DATA_URL){
    prev.innerHTML = `
      <div class="poster-drop" id="posterDrop">
        ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•´ ì—…ë¡œë“œ
        <input type="file" id="posterInput" accept="image/*" style="display:none">
      </div>`;
    $('#posterCopy').disabled=true; $('#posterClear').disabled=true;
    wirePosterInteractions();
  }else{
    prev.innerHTML = `<img src="${POSTER_DATA_URL}" alt="poster"><div class="muted">ì—…ë¡œë“œ ì™„ë£Œ</div>`;
    $('#posterCopy').disabled=false; $('#posterClear').disabled=false;
  }
}
function wirePosterInteractions(){
  const drop=document.getElementById('posterDrop');
  const input=document.getElementById('posterInput');
  if(!drop||!input) return;
  drop.addEventListener('click', ()=> input.click());
  drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.style.borderColor='#1769ff'; });
  drop.addEventListener('dragleave', ()=>{ drop.style.borderColor='#cbd5e1'; });
  drop.addEventListener('drop', e=>{ e.preventDefault(); drop.style.borderColor='#cbd5e1'; const f=e.dataTransfer.files?.[0]; if(f) handlePosterFile(f); });
  input.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) handlePosterFile(f); });
}
async function handlePosterFile(file){
  try{
    POSTER_DATA_URL = await fileToJpegDataUrl(file, 1280, 0.85);
    renderPoster();
  }catch(e){ alert('ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: '+e.message); }
}
async function fileToJpegDataUrl(file, maxW=1280, quality=0.85){
  const readAsDataURL=f=>new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f); });
  const src=await readAsDataURL(file);
  const img=await new Promise((res,rej)=>{ const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=src; });
  const scale=Math.min(1, maxW/(img.width||1));
  const w=Math.round((img.width||1)*scale), h=Math.round((img.height||1)*scale);
  const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
  const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
  return canvas.toDataURL('image/jpeg', quality);
}
document.getElementById('posterCopy').addEventListener('click', async ()=>{ if(!POSTER_DATA_URL) return; try{ await navigator.clipboard.writeText(POSTER_DATA_URL); alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'); }catch{ alert('ë³µì‚¬ ì‹¤íŒ¨'); } });
document.getElementById('posterClear').addEventListener('click', ()=>{ POSTER_DATA_URL=''; renderPoster(); });

/* ===== ì €ì¥ ë¡œì§(í•µì‹¬ ë™ì¼) ===== */
document.getElementById('toggleCodeBtn').addEventListener('click',()=>{ const i=$('#adminCode'); i.type=(i.type==='password'?'text':'password'); });
/* â€¦(upsertTournament í˜¸ì¶œ ë¶€ë¶„ì€ ì´ì „ê³¼ ë™ì¼ â€” ìƒëµ) */

/* ===== ìƒë‹¨ ë²„íŠ¼/íƒìƒ‰ ===== */
document.getElementById('settingsBtn').addEventListener('click', ()=>{
  const cur=(conf.appUrl||'').trim();
  const val=prompt('Apps Script Web App URLì„ ì…ë ¥í•˜ì„¸ìš” (â€¦/exec):',cur);
  if(val===null) return;
  conf.appUrl=(val||'').trim(); store.save(conf);
  alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.'); location.reload();
});
document.getElementById('reloadBtn').addEventListener('click', async ()=>{
  if(!(await confirmDiscardIfDirty())) return;
  await health(); await loadTournaments(); await loadTeams(); renderPoster();
});
document.getElementById('tourFilter').addEventListener('change', async ()=>{
  if(!(await confirmDiscardIfDirty())){ document.getElementById('tourFilter').value=''; return; }
  await loadTeams();
});
document.getElementById('searchBtn').addEventListener('click', loadTeams);
document.getElementById('searchText').addEventListener('keydown', e=>{ if(e.key==='Enter') loadTeams(); });

/* ===== ë¶€íŠ¸ ===== */
(async function boot(){
  await health();              // ì ìƒ‰ ì—…ë°ì´íŠ¸(ì„±ê³µ/ì‹¤íŒ¨)
  await loadTournaments();     // í•„í„°/ëª©ë¡
  await loadTeams();           // íŒ€ í‘œ
  renderPoster();              // ë“œë¡­ì¡´ ì´ˆê¸°í™”
})();
</script>
</body>
</html>
